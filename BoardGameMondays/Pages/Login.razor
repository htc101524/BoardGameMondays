@page "/login"

@using Microsoft.AspNetCore.WebUtilities
@using Microsoft.AspNetCore.Components.Web

@inject NavigationManager Navigation

<h1>Login</h1>

<form method="post" action="/account/login" data-enhance="false">
    <AntiforgeryToken />
    <div class="mb-2">
        <label class="form-label" for="login-username">Username</label>
        <input id="login-username" name="UserName" class="form-control" autocomplete="username" />
    </div>
    <div class="mb-2">
        <label class="form-label" for="login-password">Password</label>
        <div class="input-group">
            <input id="login-password" name="Password" class="form-control" type="@(_showPassword ? "text" : "password")" autocomplete="current-password" />
            <button type="button"
                    class="btn btn-outline-secondary"
                    aria-label="Hold to show password"
                    @onpointerdown="ShowPassword"
                    @onpointerup="HidePassword"
                    @onpointercancel="HidePassword"
                    @onpointerleave="HidePassword"
                    @onkeydown="OnToggleKeyDown"
                    @onkeyup="OnToggleKeyUp">
                Show
            </button>
        </div>
    </div>
    <div class="form-check mb-3">
        <input id="login-remember" name="RememberMe" value="true" type="checkbox" class="form-check-input" />
        <label class="form-check-label" for="login-remember">Remember me</label>
    </div>

    <button type="submit" class="btn btn-primary">Login</button>
    <a class="btn btn-link" href="/register">Sign up</a>
    <a class="btn btn-link" href="/forgot-password">Forgot password?</a>

    @if (_confirmSent)
    {
        <div class="text-success mt-3">Check your email for a confirmation link.</div>
    }

    @if (_resetSuccess)
    {
        <div class="text-success mt-3">Your password has been reset. You can log in now.</div>
    }

    @if (!string.IsNullOrWhiteSpace(_error))
    {
        <div class="text-danger mt-3">@_error</div>
    }
</form>

@code {
    private string? _error;
    private bool _showPassword;
    private bool _resetSuccess;
    private bool _confirmSent;

    protected override void OnParametersSet()
    {
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        var query = QueryHelpers.ParseQuery(uri.Query);
        _error = query.TryGetValue("error", out var error) ? error.ToString() : null;
        _resetSuccess = query.TryGetValue("reset", out var reset) && reset.ToString() == "1";
        _confirmSent = query.TryGetValue("confirm", out var confirm) && confirm.ToString() == "1";
    }

    private void ShowPassword() => _showPassword = true;

    private void HidePassword() => _showPassword = false;

    private void OnToggleKeyDown(KeyboardEventArgs args)
    {
        if (args is { Key: " " or "Enter" })
        {
            _showPassword = true;
        }
    }

    private void OnToggleKeyUp(KeyboardEventArgs args)
    {
        if (args is { Key: " " or "Enter" })
        {
            _showPassword = false;
        }
    }
}


