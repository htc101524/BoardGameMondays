@page "/admin/test-email"
@namespace BoardGameMondays.Pages.AdminTools
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Roles = "Admin")]

@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.Extensions.Options
@inject BoardGameMondays.Core.IEmailSender EmailSender
@inject AuthenticationStateProvider AuthStateProvider
@inject IOptions<BoardGameMondays.Core.EmailOptions> EmailOptions

<h1>Send test email</h1>

<p class="text-muted">Use this page to verify the development SMTP configuration (Mailtrap, etc.).</p>

<div class="alert alert-info" role="alert">
    <div class="fw-semibold">Email diagnostics</div>
    <div>UseApi: @EmailOptions.Value.UseApi</div>
    <div>API BaseUrl: @(string.IsNullOrWhiteSpace(EmailOptions.Value.Api.BaseUrl) ? "(not set)" : EmailOptions.Value.Api.BaseUrl)</div>
    <div>API Token header: @(string.IsNullOrWhiteSpace(EmailOptions.Value.Api.TokenHeaderName) ? "(default Authorization)" : EmailOptions.Value.Api.TokenHeaderName)</div>
    <div>SMTP Host: @(string.IsNullOrWhiteSpace(EmailOptions.Value.Smtp.Host) ? "(not set)" : EmailOptions.Value.Smtp.Host)</div>
</div>

<EditForm Model="this" OnValidSubmit="SendTestAsync">
    <div class="mb-3">
        <label class="form-label">To (email)</label>
        <InputText class="form-control" @bind-Value="Recipient" />
    </div>

    <div class="mb-3">
        <label class="form-label">Subject</label>
        <InputText class="form-control" @bind-Value="Subject" />
    </div>

    <div class="mb-3">
        <label class="form-label">HTML Body</label>
        <InputTextArea class="form-control" rows="6" @bind-Value="Body" />
    </div>

    <button type="submit" class="btn btn-primary" disabled="@_sending">Send test email</button>
    <a class="btn btn-link" href="/admin">Back to admin</a>
</EditForm>

@if (!string.IsNullOrEmpty(_message))
{
    <div class="alert @(_messageCss) mt-3" role="alert">@_message</div>
}

@if (!string.IsNullOrWhiteSpace(_details))
{
    <pre class="mt-2 text-muted" style="white-space: pre-wrap;">@_details</pre>
}

@code {
    private bool _sending;
    private string? _message;
    private string _messageCss = "alert-success";
    private string? _details;

    public string Recipient { get; set; } = string.Empty;
    public string Subject { get; set; } = "Board Game Mondays - test email";
    public string Body { get; set; } = "<p>This is a test message from Board Game Mondays.</p>";

    protected override async Task OnInitializedAsync()
    {
        var auth = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = auth.User;
        var email = user.FindFirst(System.Security.Claims.ClaimTypes.Email)?.Value;
        if (!string.IsNullOrWhiteSpace(email))
        {
            Recipient = email;
        }
    }

    private async Task SendTestAsync()
    {
        _sending = true;
        _message = null;
        _details = null;
        try
        {
            if (EmailSender is BoardGameMondays.Core.ApiEmailSender apiSender)
            {
                var response = await apiSender.SendEmailWithResultAsync(Recipient, Subject, Body);
                _message = "Test email sent (API accepted request).";
                if (!string.IsNullOrWhiteSpace(response))
                {
                    _details = response;
                }
            }
            else
            {
                await EmailSender.SendEmailAsync(Recipient, Subject, Body);
                _message = "Test email sent (SMTP).";
                _details = "SMTP send requested successfully (no API response body).";
            }
            _messageCss = "alert-success";
        }
        catch (BoardGameMondays.Core.EmailApiException ex)
        {
            _message = "Failed to send test email.";
            _details = $"Status: {ex.StatusCode}\nResponse: {ex.ResponseBody}";
            _messageCss = "alert-danger";
        }
        catch (Exception ex)
        {
            _message = "Failed to send test email: " + ex.Message;
            _messageCss = "alert-danger";
        }
        finally
        {
            _sending = false;
        }
    }
}
