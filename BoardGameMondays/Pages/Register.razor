@page "/register"

@using Microsoft.AspNetCore.WebUtilities
@using Microsoft.AspNetCore.Components.Web

@inject NavigationManager Navigation

<h1>Sign up</h1>

<form method="post" action="/account/register" data-enhance="false">
    <AntiforgeryToken />
    <input type="hidden" name="ReturnUrl" value="@(_returnUrl ?? "")" />
    <div class="mb-2">
        <label class="form-label" for="register-username">Username</label>
        <input id="register-username" name="UserName" class="form-control" autocomplete="username" />
    </div>

    <div class="mb-2">
        <label class="form-label" for="register-email">Email</label>
        <input id="register-email" name="Email" class="form-control" autocomplete="email" />
        <div class="form-text">Used for password recovery.</div>
    </div>

    <div class="mb-2">
        <label class="form-label" for="register-displayname">Name</label>
        <input id="register-displayname" name="DisplayName" class="form-control" autocomplete="name" />
    </div>

    <div class="mb-2">
        <label class="form-label" for="register-password">Password</label>
        <div class="input-group">
            <input id="register-password" name="Password" class="form-control" type="@(_showPassword ? "text" : "password")" autocomplete="new-password" />
            <button type="button"
                    class="btn btn-outline-secondary"
                    aria-label="Hold to show password"
                    @onpointerdown="ShowPassword"
                    @onpointerup="HidePassword"
                    @onpointercancel="HidePassword"
                    @onpointerleave="HidePassword"
                    @onkeydown="OnPasswordToggleKeyDown"
                    @onkeyup="OnPasswordToggleKeyUp">
                Show
            </button>
        </div>
    </div>

    <div class="mb-3">
        <label class="form-label" for="register-confirm">Confirm password</label>
        <div class="input-group">
            <input id="register-confirm" name="ConfirmPassword" class="form-control" type="@(_showConfirmPassword ? "text" : "password")" autocomplete="new-password" />
            <button type="button"
                    class="btn btn-outline-secondary"
                    aria-label="Hold to show confirm password"
                    @onpointerdown="ShowConfirmPassword"
                    @onpointerup="HideConfirmPassword"
                    @onpointercancel="HideConfirmPassword"
                    @onpointerleave="HideConfirmPassword"
                    @onkeydown="OnConfirmToggleKeyDown"
                    @onkeyup="OnConfirmToggleKeyUp">
                Show
            </button>
        </div>
    </div>

    <button type="submit" class="btn btn-primary">Create account</button>
    <a class="btn btn-link" href="@GetLoginLink()">Back to login</a>

    @if (!string.IsNullOrWhiteSpace(_error))
    {
        <div class="text-danger mt-3">@_error</div>
    }
</form>

@code {
    private string? _error;
    private bool _showPassword;
    private bool _showConfirmPassword;
    private string? _returnUrl;

    protected override void OnParametersSet()
    {
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        var query = QueryHelpers.ParseQuery(uri.Query);
        _error = query.TryGetValue("error", out var error) ? error.ToString() : null;
        _returnUrl = query.TryGetValue("returnUrl", out var returnUrl) ? returnUrl.ToString() : null;
    }

    private void ShowPassword() => _showPassword = true;

    private void HidePassword() => _showPassword = false;

    private void ShowConfirmPassword() => _showConfirmPassword = true;

    private void HideConfirmPassword() => _showConfirmPassword = false;

    private void OnPasswordToggleKeyDown(KeyboardEventArgs args)
    {
        if (args is { Key: " " or "Enter" })
        {
            _showPassword = true;
        }
    }

    private void OnPasswordToggleKeyUp(KeyboardEventArgs args)
    {
        if (args is { Key: " " or "Enter" })
        {
            _showPassword = false;
        }
    }

    private void OnConfirmToggleKeyDown(KeyboardEventArgs args)
    {
        if (args is { Key: " " or "Enter" })
        {
            _showConfirmPassword = true;
        }
    }

    private void OnConfirmToggleKeyUp(KeyboardEventArgs args)
    {
        if (args is { Key: " " or "Enter" })
        {
            _showConfirmPassword = false;
        }
    }

    private string GetLoginLink()
        => string.IsNullOrWhiteSpace(_returnUrl)
            ? "/login"
            : $"/login?returnUrl={Uri.EscapeDataString(_returnUrl)}";
}
