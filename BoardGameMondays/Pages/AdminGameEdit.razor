@page "/admin/games/{Id:guid}"
@using Microsoft.AspNetCore.Components.Web
@using static Microsoft.AspNetCore.Components.Web.RenderMode
@rendermode InteractiveServer
@using System.Linq
@using BoardGameMondays.Core
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Forms
@attribute [Authorize(Roles = "Admin")]
@inject BoardGameService BoardGameService
@inject BgmMemberDirectoryService MemberDirectory
@inject NavigationManager Navigation
@inject IAssetStorage AssetStorage

<h1>Edit game</h1>

@if (_game is null)
{
    <p>Game not found.</p>
}
else
{
    <EditForm Model="_model" OnValidSubmit="SaveAsync">
        <DataAnnotationsValidator />

        <div class="mb-3">
            <label class="form-label">Name</label>
            <InputText class="form-control" @bind-Value="_model.Name" />
        </div>

        <div class="mb-3">
            <label class="form-label">Status</label>
            <InputSelect class="form-select" TValue="GameStatus" @bind-Value="_model.Status">
                <option value="@GameStatus.Decided">Decided</option>
                <option value="@GameStatus.Playing">Playing</option>
                <option value="@GameStatus.Queued">Queued</option>
            </InputSelect>
        </div>

        <div class="mb-3">
            <label class="form-label">Tagline</label>
            <InputText class="form-control" @bind-Value="_model.Tagline" />
        </div>

        <div class="mb-3">
            <label class="form-label">Image</label>

            <div class="d-flex gap-3 flex-wrap align-items-start">
                <div style="min-width: 260px; flex: 1 1 260px;">
                    <div class="form-text">Upload</div>
                    <InputFile OnChange="UploadImageAsync" accept="image/*" />

                    @if (!string.IsNullOrWhiteSpace(_imageStatus))
                    {
                        <div class="form-text">@_imageStatus</div>
                    }
                </div>

                <div style="min-width: 260px; flex: 2 1 260px;">
                    <div class="form-text">Or paste an Image URL</div>
                    <InputText class="form-control" @bind-Value="_model.ImageUrl" />
                </div>
            </div>

            @if (!string.IsNullOrWhiteSpace(_model.ImageUrl))
            {
                <div class="mt-2">
                    <img src="@_model.ImageUrl" alt="Game image preview" style="max-width: 240px; height: auto; border-radius: var(--bs-border-radius); border: 1px solid var(--bs-border-color);" />
                </div>
            }
        </div>

        <div class="mb-3">
            <label class="form-label">Players</label>
            <div class="d-flex gap-2 flex-wrap">
                <div>
                    <div class="form-text">Min</div>
                    <InputNumber class="form-control" TValue="int?" @bind-Value="_model.MinPlayers" />
                </div>
                <div>
                    <div class="form-text">Max</div>
                    <InputNumber class="form-control" TValue="int?" @bind-Value="_model.MaxPlayers" />
                </div>
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label">Runtime (minutes)</label>
            <div class="d-flex gap-2 flex-wrap">
                <div>
                    <div class="form-text">Estimated</div>
                    <InputNumber class="form-control" TValue="int?" @bind-Value="_model.RuntimeMinutes" />
                </div>
                <div>
                    <div class="form-text">First play</div>
                    <InputNumber class="form-control" TValue="int?" @bind-Value="_model.FirstPlayRuntimeMinutes" />
                </div>
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label">Complexity</label>
            <InputNumber class="form-control" TValue="double?" @bind-Value="_model.Complexity" step="0.1" />
            <div class="form-text">Typical range is ~1â€“5.</div>
        </div>

        <div class="mb-3">
            <label class="form-label">BoardGameGeek</label>
            <div class="d-flex gap-2 flex-wrap align-items-end">
                <div style="min-width: 220px; flex: 1 1 220px;">
                    <div class="form-text">Score</div>
                    <InputNumber class="form-control" TValue="double?" @bind-Value="_model.BoardGameGeekScore" step="0.1" />
                </div>
                <div style="min-width: 260px; flex: 2 1 260px;">
                    <div class="form-text">Link</div>
                    <InputText class="form-control" @bind-Value="_model.BoardGameGeekUrl" />
                </div>
            </div>
        </div>

        <button type="submit" class="btn btn-primary">Save</button>
        <a class="btn btn-link" href="/admin">Back</a>

        @if (!string.IsNullOrWhiteSpace(_saveStatus))
        {
            <div class="text-muted mt-2">@_saveStatus</div>
        }
    </EditForm>

    <hr class="my-4" />

    <h2 class="h4">Reviews</h2>

    @if (!string.IsNullOrWhiteSpace(_playsStatus))
    {
        <div class="text-muted mb-2">@_playsStatus</div>
    }

    @if (!_game.Reviews.Any())
    {
        <p>No reviews yet.</p>
    }
    else
    {
        <div class="list-group mb-3">
            @foreach (var review in _game.Reviews)
            {
                <div class="list-group-item">
                    <div class="d-flex justify-content-between align-items-start gap-2">
                        <div class="fw-semibold">@review.Reviewer.Name</div>
                        <div class="text-muted text-nowrap">@review.Rating.ToString("0.0")</div>
                    </div>

                    <div class="d-flex justify-content-between align-items-center gap-2 mt-1">
                        <div class="text-muted">Played: @review.TimesPlayed</div>
                        <button type="button"
                                class="btn btn-sm btn-outline-secondary"
                                @onclick="@EventCallback.Factory.Create(this, () => IncrementPlaysAsync(review.Id))">+1</button>
                    </div>
                    <div>@review.Description</div>
                </div>
            }
        </div>
    }

    <h3 class="h5">Add review</h3>

    <EditForm Model="_reviewModel" OnValidSubmit="AddReviewAsync">
        <div class="mb-3">
            <label class="form-label">Reviewer</label>
            <InputSelect class="form-select" TValue="string" @bind-Value="_reviewModel.ReviewerName">
                @foreach (var member in MemberDirectory.GetAll())
                {
                    <option value="@member.Name">@member.Name</option>
                }
            </InputSelect>
        </div>

        <div class="mb-3">
            <label class="form-label">Rating</label>
            <InputNumber class="form-control" TValue="double" @bind-Value="_reviewModel.Rating" step="0.1" />
        </div>

        <div class="mb-3">
            <label class="form-label">Description</label>
            <InputTextArea class="form-control" @bind-Value="_reviewModel.Description" />
        </div>

        <button type="submit" class="btn btn-primary">Add review</button>

        @if (!string.IsNullOrWhiteSpace(_reviewStatus))
        {
            <div class="text-muted mt-2">@_reviewStatus</div>
        }
    </EditForm>
}

@code {
    [Parameter]
    public Guid Id { get; set; }

    private BoardGame? _game;
    private EditGameModel _model = new();
    private string? _saveStatus;
    private string? _imageStatus;

    private static readonly HashSet<string> AllowedImageExtensions = new(StringComparer.OrdinalIgnoreCase)
    {
        ".png",
        ".jpg",
        ".jpeg",
        ".webp",
        ".gif"
    };

    private AddReviewModel _reviewModel = new();
    private string? _reviewStatus;
    private string? _playsStatus;

    protected override async Task OnParametersSetAsync()
    {
        _game = await BoardGameService.GetByIdAsync(Id);
        if (_game is null)
        {
            return;
        }

        _model = new EditGameModel
        {
            Name = _game.Name,
            Status = _game.Status,
            Tagline = _game.Tagline,
            ImageUrl = _game.ImageUrl,
            MinPlayers = _game.MinPlayers,
            MaxPlayers = _game.MaxPlayers,
            RuntimeMinutes = _game.RuntimeMinutes,
            FirstPlayRuntimeMinutes = _game.FirstPlayRuntimeMinutes,
            Complexity = _game.Complexity,
            BoardGameGeekScore = _game.BoardGameGeekScore,
            BoardGameGeekUrl = _game.BoardGameGeekUrl
        };

        var members = MemberDirectory.GetAll();
        _reviewModel.ReviewerName = members.FirstOrDefault()?.Name ?? string.Empty;
        _reviewModel.Rating = 8;
        _reviewModel.Description = string.Empty;
    }

    private async Task SaveAsync()
    {
        var updated = await BoardGameService.UpdateGameAsync(
            id: Id,
            name: _model.Name,
            status: _model.Status,
            tagline: _model.Tagline,
            imageUrl: _model.ImageUrl,
            minPlayers: _model.MinPlayers,
            maxPlayers: _model.MaxPlayers,
            runtimeMinutes: _model.RuntimeMinutes,
            firstPlayRuntimeMinutes: _model.FirstPlayRuntimeMinutes,
            complexity: _model.Complexity,
            boardGameGeekScore: _model.BoardGameGeekScore,
            boardGameGeekUrl: _model.BoardGameGeekUrl);

        _game = updated;
        _saveStatus = updated is null ? "Game not found." : "Saved.";
    }

    private async Task UploadImageAsync(InputFileChangeEventArgs e)
    {
        _imageStatus = null;

        if (_game is null)
        {
            _imageStatus = "Game not loaded yet.";
            return;
        }

        var file = e.File;
        if (file is null)
        {
            return;
        }

        if (!file.ContentType.StartsWith("image/", StringComparison.OrdinalIgnoreCase))
        {
            _imageStatus = "Please upload an image file.";
            return;
        }

        const long maxBytes = 5 * 1024 * 1024;
        if (file.Size > maxBytes)
        {
            _imageStatus = "Image is too large (max 5 MB).";
            return;
        }

        string? ext;
        await using (var sniffStream = file.OpenReadStream(maxAllowedSize: maxBytes))
        {
            ext = await ImageFileSniffer.DetectExtensionAsync(sniffStream);
        }

        if (string.IsNullOrWhiteSpace(ext) || !AllowedImageExtensions.Contains(ext))
        {
            _imageStatus = "Supported formats: png, jpg, webp, gif.";
            return;
        }

        if (string.Equals(ext, ".jpeg", StringComparison.OrdinalIgnoreCase))
        {
            ext = ".jpg";
        }

        try
        {
            await using var stream = file.OpenReadStream(maxAllowedSize: maxBytes);
            _model.ImageUrl = await AssetStorage.SaveGameImageAsync(stream, ext);
            _imageStatus = "Uploaded. Click Save to persist.";
        }
        catch (Exception ex)
        {
            _imageStatus = $"Upload failed: {ex.Message}";
        }
    }

    private async Task AddReviewAsync()
    {
        if (_game is null)
        {
            return;
        }

        var reviewer = MemberDirectory.GetOrCreate(_reviewModel.ReviewerName);
        var review = new MemberReview(reviewer, _reviewModel.Rating, _reviewModel.Description ?? string.Empty);

        var updated = await BoardGameService.AddReviewAsync(_game.Id, review);
        _game = updated;
        _reviewStatus = updated is null ? "Game not found." : "Review added.";

        _reviewModel.Description = string.Empty;
    }

    private async Task IncrementPlaysAsync(Guid reviewId)
    {
        if (_game is null)
        {
            return;
        }

        _playsStatus = null;

        if (reviewId == Guid.Empty)
        {
            _playsStatus = "This review can't be updated yet. Refresh the page and try again.";
            return;
        }

        try
        {
            var newValue = await BoardGameService.IncrementReviewTimesPlayedAsync(reviewId);
            if (newValue is null)
            {
                _playsStatus = "Review not found.";
                return;
            }

            _game = await BoardGameService.GetByIdAsync(Id);
            _playsStatus = $"Updated (now {newValue}).";

            StateHasChanged();
        }
        catch (Exception ex)
        {
            _playsStatus = $"Could not update: {ex.Message}";
        }
    }

    private sealed class EditGameModel
    {
        public string Name { get; set; } = string.Empty;
        public GameStatus Status { get; set; }
        public string? Tagline { get; set; }
        public string? ImageUrl { get; set; }

        public int? MinPlayers { get; set; }
        public int? MaxPlayers { get; set; }
        public int? RuntimeMinutes { get; set; }
        public int? FirstPlayRuntimeMinutes { get; set; }
        public double? Complexity { get; set; }
        public double? BoardGameGeekScore { get; set; }
        public string? BoardGameGeekUrl { get; set; }
    }

    private sealed class AddReviewModel
    {
        public string ReviewerName { get; set; } = string.Empty;
        public double Rating { get; set; } = 8;
        public string? Description { get; set; }
    }
}
