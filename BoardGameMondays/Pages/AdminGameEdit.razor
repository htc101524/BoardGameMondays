@page "/admin/games/{Id:guid}"
@using Microsoft.AspNetCore.Components.Web
@using static Microsoft.AspNetCore.Components.Web.RenderMode
@rendermode InteractiveServer
@using System.Linq
@using BoardGameMondays.Core
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Forms
@attribute [Authorize(Roles = "Admin")]
@inject BoardGameService BoardGameService
@inject BgmMemberDirectoryService MemberDirectory
@inject NavigationManager Navigation

<h1>Edit game</h1>

@if (_game is null)
{
    <p>Game not found.</p>
}
else
{
    <EditForm Model="_model" OnValidSubmit="SaveAsync">
        <DataAnnotationsValidator />

        <div class="mb-3">
            <label class="form-label">Name</label>
            <InputText class="form-control" @bind-Value="_model.Name" />
        </div>

        <div class="mb-3">
            <label class="form-label">Status</label>
            <InputSelect class="form-select" TValue="GameStatus" @bind-Value="_model.Status">
                <option value="@GameStatus.Decided">Decided</option>
                <option value="@GameStatus.Playing">Playing</option>
                <option value="@GameStatus.Queued">Queued</option>
            </InputSelect>
        </div>

        <div class="mb-3">
            <label class="form-label">Tagline</label>
            <InputText class="form-control" @bind-Value="_model.Tagline" />
        </div>

        <div class="mb-3">
            <label class="form-label">Image URL</label>
            <InputText class="form-control" @bind-Value="_model.ImageUrl" />
        </div>

        <button type="submit" class="btn btn-primary">Save</button>
        <a class="btn btn-link" href="/admin">Back</a>

        @if (!string.IsNullOrWhiteSpace(_saveStatus))
        {
            <div class="text-muted mt-2">@_saveStatus</div>
        }
    </EditForm>

    <hr class="my-4" />

    <h2 class="h4">Reviews</h2>

    @if (!string.IsNullOrWhiteSpace(_playsStatus))
    {
        <div class="text-muted mb-2">@_playsStatus</div>
    }

    @if (!_game.Reviews.Any())
    {
        <p>No reviews yet.</p>
    }
    else
    {
        <div class="list-group mb-3">
            @foreach (var review in _game.Reviews)
            {
                <div class="list-group-item">
                    <div class="d-flex justify-content-between align-items-start gap-2">
                        <div class="fw-semibold">@review.Reviewer.Name</div>
                        <div class="text-muted text-nowrap">@review.Rating.ToString("0.0")</div>
                    </div>

                    <div class="d-flex justify-content-between align-items-center gap-2 mt-1">
                        <div class="text-muted">Played: @review.TimesPlayed</div>
                        <button type="button"
                                class="btn btn-sm btn-outline-secondary"
                                @onclick="@EventCallback.Factory.Create(this, () => IncrementPlaysAsync(review.Id))">+1</button>
                    </div>
                    <div>@review.Description</div>
                </div>
            }
        </div>
    }

    <h3 class="h5">Add review</h3>

    <EditForm Model="_reviewModel" OnValidSubmit="AddReviewAsync">
        <div class="mb-3">
            <label class="form-label">Reviewer</label>
            <InputSelect class="form-select" TValue="string" @bind-Value="_reviewModel.ReviewerName">
                @foreach (var member in MemberDirectory.GetAll())
                {
                    <option value="@member.Name">@member.Name</option>
                }
            </InputSelect>
        </div>

        <div class="mb-3">
            <label class="form-label">Rating</label>
            <InputNumber class="form-control" TValue="double" @bind-Value="_reviewModel.Rating" step="0.1" />
        </div>

        <div class="mb-3">
            <label class="form-label">Description</label>
            <InputTextArea class="form-control" @bind-Value="_reviewModel.Description" />
        </div>

        <button type="submit" class="btn btn-primary">Add review</button>

        @if (!string.IsNullOrWhiteSpace(_reviewStatus))
        {
            <div class="text-muted mt-2">@_reviewStatus</div>
        }
    </EditForm>
}

@code {
    [Parameter]
    public Guid Id { get; set; }

    private BoardGame? _game;
    private EditGameModel _model = new();
    private string? _saveStatus;

    private AddReviewModel _reviewModel = new();
    private string? _reviewStatus;
    private string? _playsStatus;

    protected override async Task OnParametersSetAsync()
    {
        _game = await BoardGameService.GetByIdAsync(Id);
        if (_game is null)
        {
            return;
        }

        _model = new EditGameModel
        {
            Name = _game.Name,
            Status = _game.Status,
            Tagline = _game.Tagline,
            ImageUrl = _game.ImageUrl
        };

        var members = MemberDirectory.GetAll();
        _reviewModel.ReviewerName = members.FirstOrDefault()?.Name ?? string.Empty;
        _reviewModel.Rating = 8;
        _reviewModel.Description = string.Empty;
    }

    private async Task SaveAsync()
    {
        var updated = await BoardGameService.UpdateGameAsync(
            id: Id,
            name: _model.Name,
            status: _model.Status,
            tagline: _model.Tagline,
            imageUrl: _model.ImageUrl);

        _game = updated;
        _saveStatus = updated is null ? "Game not found." : "Saved.";
    }

    private async Task AddReviewAsync()
    {
        if (_game is null)
        {
            return;
        }

        var reviewer = MemberDirectory.GetOrCreate(_reviewModel.ReviewerName);
        var review = new MemberReview(reviewer, _reviewModel.Rating, _reviewModel.Description ?? string.Empty);

        var updated = await BoardGameService.AddReviewAsync(_game.Id, review);
        _game = updated;
        _reviewStatus = updated is null ? "Game not found." : "Review added.";

        _reviewModel.Description = string.Empty;
    }

    private async Task IncrementPlaysAsync(Guid reviewId)
    {
        if (_game is null)
        {
            return;
        }

        _playsStatus = null;

        if (reviewId == Guid.Empty)
        {
            _playsStatus = "This review can't be updated yet. Refresh the page and try again.";
            return;
        }

        try
        {
            var newValue = await BoardGameService.IncrementReviewTimesPlayedAsync(reviewId);
            if (newValue is null)
            {
                _playsStatus = "Review not found.";
                return;
            }

            _game = await BoardGameService.GetByIdAsync(Id);
            _playsStatus = $"Updated (now {newValue}).";

            StateHasChanged();
        }
        catch (Exception ex)
        {
            _playsStatus = $"Could not update: {ex.Message}";
        }
    }

    private sealed class EditGameModel
    {
        public string Name { get; set; } = string.Empty;
        public GameStatus Status { get; set; }
        public string? Tagline { get; set; }
        public string? ImageUrl { get; set; }
    }

    private sealed class AddReviewModel
    {
        public string ReviewerName { get; set; } = string.Empty;
        public double Rating { get; set; } = 8;
        public string? Description { get; set; }
    }
}
