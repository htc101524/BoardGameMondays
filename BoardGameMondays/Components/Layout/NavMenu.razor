@using BoardGameMondays.Core
@using Microsoft.AspNetCore.Components.Authorization
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject AuthenticationStateProvider AuthStateProvider
@inject BoardGameMondays.Core.BgmCoinService Coins
@inject BoardGameMondays.Core.BettingService BettingService
@inject UserPreferencesService PreferencesService
@inject IHttpContextAccessor HttpContextAccessor

@implements IDisposable

<header class="bgm-header" role="banner">
    <div class="bgm-header__inner">
        <div class="bgm-menuArea" @onclick="ToggleMenu" role="button" tabindex="0" aria-label="Open menu" aria-controls="bgm-popup" aria-expanded="@_menuOpen">
            <div class=@(_menuOpen ? "bgm-menuButton is-open" : "bgm-menuButton")>
                <svg viewBox="0 0 48 48" class="bgm-menuIcon" aria-hidden="true" focusable="false">
                    <path d="M10 14 H38" />
                    <path d="M10 24 H38" />
                    <path d="M10 34 H38" />
                </svg>
            </div>
        </div>

        @* Desktop: show brand and main nav links *@
        <a class="bgm-header__brand" href="/" @onclick="OnBrandClick" @onclick:preventDefault>
            <span class="bgm-header__brandText">BOARD GAME MONDAYS</span>
        </a>

        @* Mobile: centered short title *@
        <div class="bgm-header__center">
            <a class="bgm-header__title" href="/" @onclick="OnBrandClick" @onclick:preventDefault>BG MONDAYS</a>
        </div>

        <div class="bgm-header__right">
            @if (_userId is not null)
            {
                @if (!string.IsNullOrWhiteSpace(_userName))
                {
                    <div class="text-muted small me-2" style="display: flex; align-items: center;">@_userName</div>
                }
                <button class="bgm-coins bgm-coinsButton" type="button" aria-label="BGM Coins" @onclick="ToggleBetsAsync">
                    <span class="bgm-coins__label">£:</span>
                    <span class="bgm-coins__value">@(_coins?.ToString() ?? "…")</span>
                </button>
            }

            @* Desktop-only nav items *@
            <div class="bgm-header__desktopActions">
                <div class="bgm-header__dropdown">
                    <button type="button" class="bgm-header__actionLink bgm-header__dropdownToggle" @onclick="ToggleDropdown" aria-haspopup="true" aria-expanded="@_dropdownOpen">
                        Home
                        <span class="bgm-header__dropdownChevron @(_dropdownOpen ? "is-open" : "")">▼</span>
                    </button>
                    <div class="bgm-header__dropdownMenu @(_dropdownOpen ? "is-open" : "")">
                        <a class="bgm-header__dropdownItem" href="/#games" @onclick="CloseDropdownAfterClick">Games</a>
                        <a class="bgm-header__dropdownItem" href="/#mondays" @onclick="CloseDropdownAfterClick">Mondays</a>
                        <a class="bgm-header__dropdownItem" href="/#people" @onclick="CloseDropdownAfterClick">People</a>
                    </div>
                </div>
                <a class="bgm-header__actionLink" href="/blog">Blog</a>
                
                @if (_userId is not null)
                {
                    <a class="bgm-header__actionLink" href="/account/email">Account</a>
                    @if (_userIsAdmin)
                    {
                        <a class="bgm-header__actionLink bgm-header__actionLink--admin" href="/admin">Admin</a>
                    }
                    <form method="post" action="/account/logout" data-enhance="false" class="bgm-header__logoutForm">
                        <button type="submit" class="bgm-header__actionLink bgm-header__actionLink--logout">Logout</button>
                    </form>
                }
                else
                {
                    <a class="bgm-header__actionLink" href="/login">Login</a>
                    <a class="bgm-header__actionLink bgm-header__actionLink--signup" href="/register">Sign up</a>
                    <span class="text-muted small ms-2">Log in to bet on who you think will win.</span>
                }
            </div>
        </div>
    </div>
</header>

<div class="bgm-backdrop @(_menuOpen ? "is-open" : "")" @onclick="CloseMenu"></div>

<div class="bgm-betsBackdrop @(_betsOpen ? "is-open" : "")" @onclick="CloseBets"></div>

<aside class="bgm-betsModal @(_betsOpen ? "is-open" : "")" role="dialog" aria-modal="true" aria-label="Bet history">
    <div class="bgm-betsModal__header">
        <div>
            <div class="bgm-betsModal__title">My bets</div>
            <div class="bgm-betsModal__subtitle">Odds are locked when you place a bet.</div>
        </div>
        <button type="button" class="bgm-betsModal__close" aria-label="Close" @onclick="CloseBets">×</button>
    </div>

    @if (_betsLoading)
    {
        <div class="text-muted">Loading bets…</div>
    }
    else if (_betHistory.Count == 0)
    {
        <div class="text-muted">No bets yet.</div>
    }
    else
    {
        var open = _betHistory.Where(b => !b.IsResolved).ToArray();
        var settled = _betHistory.Where(b => b.IsResolved).ToArray();

        <div class="bgm-betsModal__summary">
            <span>Open: <strong>@open.Length</strong></span>
            <span>Settled: <strong>@settled.Length</strong></span>
        </div>

        @if (open.Length > 0)
        {
            <div class="bgm-betsModal__section">
                <div class="bgm-betsModal__sectionTitle">Open bets</div>
                <ul class="bgm-betsModal__list">
                    @foreach (var bet in open.Take(3))
                    {
                        <li>
                            <strong>@bet.GameName</strong>
                            <span>@FormatDate(bet.GameDate)</span>
                            <span>@bet.PredictedWinnerName</span>
                            <span>@OddsFormatter.Format(bet.OddsTimes100, _oddsFormat)</span>
                        </li>
                    }
                </ul>
            </div>
        }

        @if (settled.Length > 0)
        {
            <div class="bgm-betsModal__section">
                <div class="bgm-betsModal__sectionTitle">Settled bets</div>
                <ul class="bgm-betsModal__list">
                    @foreach (var bet in settled.Take(3))
                    {
                        var net = bet.Payout - bet.Amount;
                        <li>
                            <strong>@bet.GameName</strong>
                            <span>@FormatDate(bet.GameDate)</span>
                            <span>@FormatNet(net)</span>
                        </li>
                    }
                </ul>
            </div>
        }
    }

    <div class="bgm-betsModal__section">
        <div class="bgm-betsModal__sectionTitle">Monday coins</div>
        @if (_pendingMondayCoinsLoading)
        {
            <div class="text-muted">Checking attendance...</div>
        }
        else if (_pendingMondayCoins <= 0)
        {
            <div class="text-muted">No Monday coins to claim yet.</div>
        }
        else
        {
            <div class="bgm-betsModal__summary bgm-betsModal__summary--compact">
                <span>Pending: <strong>@_pendingMondayCoins</strong></span>
                <button type="button"
                        class="bgm-betsModal__claim"
                        @onclick="ClaimMondayCoinsAsync"
                        disabled="@_claimingMondayCoins">
                    @(_claimingMondayCoins ? "Claiming..." : "Claim coins")
                </button>
            </div>
        }
    </div>

    <div class="bgm-betsModal__footer">
        <a class="bgm-betsModal__link" href="/leaderboard" @onclick="CloseBets">🏆 View leaderboard</a>
        <a class="bgm-betsModal__link" href="/bets" @onclick="CloseBets">View all bets</a>
    </div>
</aside>

<aside id="bgm-popup" class="bgm-popup @(_menuOpen ? "is-open" : "")" role="dialog" aria-modal="true">
    <nav class="bgm-popup__nav" aria-label="Menu">
        <div class="bgm-popup__parent">
            <a class="bgm-popup__link" href="/" @onclick="OnBrandClickMobile" @onclick:preventDefault>Home</a>
            <div class="bgm-popup__children">
                <a class="bgm-popup__link bgm-popup__link--child" href="/#games" @onclick="CloseMenu">Games</a>
                <a class="bgm-popup__link bgm-popup__link--child" href="/#mondays" @onclick="CloseMenu">Mondays</a>
                <a class="bgm-popup__link bgm-popup__link--child" href="/#people" @onclick="CloseMenu">People</a>
            </div>
        </div>
        <a class="bgm-popup__link" href="/blog" @onclick="CloseMenu">Blog</a>
        <a class="bgm-popup__link bgm-popup__link--donate" href="https://buymeacoffee.com/henrytcarter" target="_blank" rel="noopener noreferrer" @onclick="CloseMenu">Buy us a coffee</a>

        @if (_userId is not null)
        {
            <a class="bgm-popup__link" href="/account/email" @onclick="CloseMenu">Account</a>

            @if (_userIsAdmin)
            {
                <a class="bgm-popup__link" href="/admin" @onclick="CloseMenu">Admin</a>
            }

            <form method="post" action="/account/logout" data-enhance="false">
                @* Antiforgery is handled by ASP.NET Core; no explicit token component needed here. *@
                <button type="submit" class="bgm-popup__link bgm-popup__linkButton" @onclick="CloseMenu">Logout</button>
            </form>
        }
        else
        {
            <button type="button" class="bgm-popup__link bgm-popup__linkButton" @onclick="GoToLogin">Login</button>
            <button type="button" class="bgm-popup__link bgm-popup__linkButton" @onclick="GoToRegister">Sign up</button>
            <div class="text-muted small px-3">Log in to bet on who you think will win.</div>
        }
    </nav>
</aside>

@code {
    private bool _menuOpen;
    private bool _dropdownOpen;
    private string? _userId;
    private string? _userName;
    private int? _coins;
    private int _pendingMondayCoins;
    private bool _pendingMondayCoinsLoading;
    private bool _claimingMondayCoins;
    private bool _userIsAdmin;
    private bool _betsOpen;
    private bool _betsLoading;
    private IReadOnlyList<BoardGameMondays.Core.BettingService.UserBetHistory> _betHistory = Array.Empty<BoardGameMondays.Core.BettingService.UserBetHistory>();
    private OddsDisplayFormat _oddsFormat = OddsDisplayFormat.Fraction;
    
    private bool _disposed;

    protected override async Task OnInitializedAsync()
    {
        AuthStateProvider.AuthenticationStateChanged += OnAuthStateChanged;
        Coins.Changed += OnCoinsChanged;
        await RefreshCoinsAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await RefreshCoinsAsync();
        }
    }

    public void Dispose()
    {
        _disposed = true;
        AuthStateProvider.AuthenticationStateChanged -= OnAuthStateChanged;
        Coins.Changed -= OnCoinsChanged;
    }

    private void OnAuthStateChanged(Task<AuthenticationState> task)
    {
        _ = InvokeAsync(async () =>
        {
            if (_disposed) return;
            await task;
            if (_disposed) return;
            await RefreshCoinsAsync();
        });
    }

    private void OnCoinsChanged()
    {
        _ = InvokeAsync(async () =>
        {
            if (_disposed) return;
            await RefreshCoinsAsync();
        });
    }

    private async Task ToggleBetsAsync()
    {
        if (_userId is null)
        {
            return;
        }

        if (_betsOpen)
        {
            CloseBets();
            return;
        }

        _betsOpen = true;
        await RefreshPendingMondayCoinsAsync();
        if (_betHistory.Count == 0)
        {
            _betsLoading = true;
            try
            {
                _betHistory = await BettingService.GetUserBetHistoryAsync(_userId);
            }
            finally
            {
                _betsLoading = false;
            }
        }
    }

    private void CloseBets() => _betsOpen = false;

    private async Task RefreshCoinsAsync()
    {
        var auth = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = auth.User;

        if (user.Identity?.IsAuthenticated != true)
        {
            _userId = null;
            _userName = null;
            _coins = null;
            _pendingMondayCoins = 0;
            _userIsAdmin = false;
            StateHasChanged();
            return;
        }

        _userId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
        _userName = user.Identity?.Name;
        _userIsAdmin = user.IsInRole("Admin");

        if (string.IsNullOrWhiteSpace(_userId))
        {
            _coins = null;
            _pendingMondayCoins = 0;
            StateHasChanged();
            return;
        }

        _coins = await Coins.GetCoinsAsync(_userId);
        _oddsFormat = await PreferencesService.GetOddsDisplayFormatAsync(_userId);
        StateHasChanged();
    }

    private async Task RefreshPendingMondayCoinsAsync()
    {
        if (string.IsNullOrWhiteSpace(_userId))
        {
            _pendingMondayCoins = 0;
            return;
        }

        _pendingMondayCoinsLoading = true;
        try
        {
            _pendingMondayCoins = await Coins.GetPendingMondayAttendanceCoinsAsync(_userId);
        }
        finally
        {
            _pendingMondayCoinsLoading = false;
            StateHasChanged();
        }
    }

    private async Task ClaimMondayCoinsAsync()
    {
        if (_claimingMondayCoins || string.IsNullOrWhiteSpace(_userId))
        {
            return;
        }

        _claimingMondayCoins = true;
        try
        {
            await Coins.ClaimMondayAttendanceCoinsAsync(_userId);
            await RefreshCoinsAsync();
            _pendingMondayCoins = await Coins.GetPendingMondayAttendanceCoinsAsync(_userId);
        }
        finally
        {
            _claimingMondayCoins = false;
            StateHasChanged();
        }
    }

    private void ToggleMenu() => _menuOpen = !_menuOpen;
    private void CloseMenu() => _menuOpen = false;

    private void OpenDropdown() => _dropdownOpen = true;
    private void CloseDropdown() => _dropdownOpen = false;
    private void ToggleDropdown() => _dropdownOpen = !_dropdownOpen;
    private void CloseDropdownAfterClick()
    {
        _dropdownOpen = false;
        StateHasChanged();
    }

    private async Task OnBrandClick()
    {
        CloseMenu();
        CloseDropdown();
        Navigation.NavigateTo("/#latest");
        await JS.InvokeVoidAsync("bgm.scrollToTopNextFrame", "smooth");
    }

    private async Task OnBrandClickMobile()
    {
        CloseMenu();
        Navigation.NavigateTo("/#latest");
        await JS.InvokeVoidAsync("bgm.scrollToTopNextFrame", "smooth");
    }

    private void GoToLogin()
    {
        CloseMenu();
        Navigation.NavigateTo("/login");
    }

    private void GoToRegister()
    {
        CloseMenu();
        Navigation.NavigateTo("/register");
    }

    private static string FormatDate(DateOnly date)
        => date.ToDateTime(TimeOnly.MinValue).ToString("d MMM yyyy");

    private static string FormatNet(int net)
        => net >= 0 ? $"+{net}" : net.ToString();
}
