@using Microsoft.AspNetCore.Components.Authorization
@using BoardGameMondays.Core
@inject AuthenticationStateProvider AuthStateProvider
@inject BgmMemberService MemberService
@inject NavigationManager Navigation
@inject IJSRuntime JS

<header class="bgm-header" role="banner">
    <div class="bgm-header__inner">
        <a class="bgm-brand"
           href="/#latest"
           aria-label="Board Game Mondays"
           @onclick:preventDefault="true"
           @onclick="OnBrandClick">
            <img class="bgm-brand__logo" src="images/bgm-logo.svg" alt="" />
            <span class="bgm-brand__text">Board Game Mondays</span>
        </a>

        <button class="bgm-menuButton"
                type="button"
                aria-label="Open menu"
                aria-controls="bgm-popup"
                aria-expanded="@_menuOpen"
                @onclick="ToggleMenu">
            <svg viewBox="0 0 48 48" class="bgm-menuIcon" aria-hidden="true" focusable="false">
                <path d="M10 14 H38" />
                <path d="M10 24 H38" />
                <path d="M10 34 H38" />
            </svg>
        </button>
    </div>
</header>

<div class="bgm-backdrop @(_menuOpen ? "is-open" : "")" @onclick="CloseMenu"></div>

<aside id="bgm-popup" class="bgm-popup @(_menuOpen ? "is-open" : "")" role="dialog" aria-modal="true">
    <nav class="bgm-popup__nav" aria-label="Menu">
        <a class="bgm-popup__link" href="/#games" @onclick="CloseMenu">Games</a>
        <a class="bgm-popup__link" href="/#people" @onclick="CloseMenu">People</a>

        <AuthorizeView>
            <Authorized>
                <button type="button" class="bgm-popup__link bgm-popup__linkButton" @onclick="Logout">Logout</button>
            </Authorized>
            <NotAuthorized>
                <button type="button" class="bgm-popup__link bgm-popup__linkButton" @onclick="GoToLogin">Login</button>
            </NotAuthorized>
        </AuthorizeView>
    </nav>
</aside>

@code {
    private bool _menuOpen;

    private void ToggleMenu() => _menuOpen = !_menuOpen;
    private void CloseMenu() => _menuOpen = false;

    private async Task OnBrandClick()
    {
        CloseMenu();
        Navigation.NavigateTo("/#latest");
        await JS.InvokeVoidAsync("bgm.scrollToTopNextFrame", "smooth");
    }

    private async Task Logout()
    {
        if (AuthStateProvider is SimpleAuthStateProvider simple)
        {
            await simple.MarkUserAsLoggedOut();
        }

        MemberService.ClearMember();
        CloseMenu();
        Navigation.NavigateTo("/");
    }

    private void GoToLogin()
    {
        CloseMenu();
        Navigation.NavigateTo("/login");
    }
}

