@using Microsoft.AspNetCore.Components.Authorization
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject AuthenticationStateProvider AuthStateProvider
@inject BoardGameMondays.Core.BgmCoinService Coins
@inject IHttpContextAccessor HttpContextAccessor

@implements IDisposable

<header class="bgm-header" role="banner">
    <div class="bgm-header__inner">
        <a class="bgm-brand"
           href="/#latest"
           aria-label="Board Game Mondays"
           @onclick:preventDefault="true"
           @onclick="OnBrandClick">
            <img class="bgm-brand__logo" src="images/bgm-logo.svg" alt="" />
            <span class="bgm-brand__text">BGM</span>
        </a>

        <div class="bgm-header__right">
            @if (_userId is not null)
            {
                <div class="bgm-coins" aria-label="BGM Coins">
                    <span class="bgm-coins__label">£:</span>
                    <span class="bgm-coins__value">@(_coins?.ToString() ?? "…")</span>
                </div>
            }

            <button class="bgm-menuButton"
                    type="button"
                    aria-label="Open menu"
                    aria-controls="bgm-popup"
                    aria-expanded="@_menuOpen"
                    @onclick="ToggleMenu">
                <svg viewBox="0 0 48 48" class="bgm-menuIcon" aria-hidden="true" focusable="false">
                    <path d="M10 14 H38" />
                    <path d="M10 24 H38" />
                    <path d="M10 34 H38" />
                </svg>
            </button>
        </div>
    </div>
</header>

<div class="bgm-backdrop @(_menuOpen ? "is-open" : "")" @onclick="CloseMenu"></div>

<aside id="bgm-popup" class="bgm-popup @(_menuOpen ? "is-open" : "")" role="dialog" aria-modal="true">
    <nav class="bgm-popup__nav" aria-label="Menu">
        <a class="bgm-popup__link" href="/#games" @onclick="CloseMenu">Games</a>
        <a class="bgm-popup__link" href="/#mondays" @onclick="CloseMenu">Mondays</a>
        <a class="bgm-popup__link" href="/#blog" @onclick="CloseMenu">Blog</a>
        <a class="bgm-popup__link" href="/#people" @onclick="CloseMenu">People</a>

        @if (_userId is not null)
        {
            @if (_userIsRealAdmin)
            {
                <div class="bgm-popup__link bgm-popup__toggleRow" aria-label="Admin view mode">
                    <div class="form-check form-switch m-0">
                        <input class="form-check-input" type="checkbox" role="switch" id="bgm-viewAsNonAdmin"
                               checked="@_viewAsNonAdmin" @onchange="OnViewAsNonAdminChanged">
                        <label class="form-check-label" for="bgm-viewAsNonAdmin">View as non-admin</label>
                    </div>
                </div>
            }

            <AuthorizeView Roles="Admin">
                <Authorized>
                    <a class="bgm-popup__link" href="/admin" @onclick="CloseMenu">Admin</a>
                </Authorized>
            </AuthorizeView>

            <form method="post" action="/account/logout" data-enhance="false">
                @* Antiforgery is handled by ASP.NET Core; no explicit token component needed here. *@
                <button type="submit" class="bgm-popup__link bgm-popup__linkButton" @onclick="CloseMenu">Logout</button>
            </form>
        }
        else
        {
            <button type="button" class="bgm-popup__link bgm-popup__linkButton" @onclick="GoToLogin">Login</button>
            <button type="button" class="bgm-popup__link bgm-popup__linkButton" @onclick="GoToRegister">Sign up</button>
        }
    </nav>
</aside>

@code {
    private const string ViewAsNonAdminCookie = "bgm_viewAsNonAdmin";

    private bool _menuOpen;
    private string? _userId;
    private int? _coins;
    private bool _userIsAdmin;
    private bool _userIsRealAdmin;
    private bool _viewAsNonAdmin;
    private bool _isInteractive;

    protected override async Task OnInitializedAsync()
    {
        AuthStateProvider.AuthenticationStateChanged += OnAuthStateChanged;
        Coins.Changed += OnCoinsChanged;
        await RefreshCoinsAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _isInteractive = true;
            await RefreshCoinsAsync();
        }
    }

    public void Dispose()
    {
        AuthStateProvider.AuthenticationStateChanged -= OnAuthStateChanged;
        Coins.Changed -= OnCoinsChanged;
    }

    private void OnAuthStateChanged(Task<AuthenticationState> task)
    {
        _ = InvokeAsync(async () =>
        {
            await task;
            await RefreshCoinsAsync();
        });
    }

    private void OnCoinsChanged()
    {
        _ = InvokeAsync(RefreshCoinsAsync);
    }

    private async Task RefreshCoinsAsync()
    {
        var auth = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = auth.User;

        if (user.Identity?.IsAuthenticated != true)
        {
            _userId = null;
            _coins = null;
            _userIsAdmin = false;
            StateHasChanged();
            return;
        }

        _userId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
        _userIsAdmin = user.IsInRole("Admin");
        _userIsRealAdmin = _userIsAdmin || user.HasClaim(c => c.Type == "bgm:realAdmin" && c.Value == "1");

        if (_userIsRealAdmin)
        {
            // During prerender, JS interop is unavailable. Prefer server-side cookie access when possible.
            var serverCookie = HttpContextAccessor.HttpContext?.Request.Cookies[ViewAsNonAdminCookie];
            if (!string.IsNullOrWhiteSpace(serverCookie))
            {
                _viewAsNonAdmin = string.Equals(serverCookie, "1", StringComparison.Ordinal);
            }
            else if (_isInteractive)
            {
                try
                {
                    var cookie = await JS.InvokeAsync<string?>("bgm.getCookie", ViewAsNonAdminCookie);
                    _viewAsNonAdmin = string.Equals(cookie, "1", StringComparison.Ordinal);
                }
                catch
                {
                    _viewAsNonAdmin = false;
                }
            }
            else
            {
                _viewAsNonAdmin = false;
            }
        }
        else
        {
            _viewAsNonAdmin = false;
        }

        if (string.IsNullOrWhiteSpace(_userId))
        {
            _coins = null;
            StateHasChanged();
            return;
        }

        _coins = await Coins.GetCoinsAsync(_userId);
        StateHasChanged();
    }

    private async Task OnViewAsNonAdminChanged(ChangeEventArgs e)
    {
        if (!_userIsRealAdmin)
        {
            return;
        }

        var enabled = e.Value is bool b
            ? b
            : string.Equals(e.Value?.ToString(), "true", StringComparison.OrdinalIgnoreCase)
              || string.Equals(e.Value?.ToString(), "on", StringComparison.OrdinalIgnoreCase)
              || string.Equals(e.Value?.ToString(), "1", StringComparison.OrdinalIgnoreCase);

        _viewAsNonAdmin = enabled;

        try
        {
            await JS.InvokeVoidAsync("bgm.setViewAsNonAdmin", enabled);
        }
        catch
        {
            // If cookies are blocked, fail safe: don't change view mode.
            _viewAsNonAdmin = false;
            return;
        }

        CloseMenu();
        Navigation.NavigateTo(Navigation.Uri, forceLoad: true);
    }

    private void ToggleMenu() => _menuOpen = !_menuOpen;
    private void CloseMenu() => _menuOpen = false;

    private async Task OnBrandClick()
    {
        CloseMenu();
        Navigation.NavigateTo("/#latest");
        await JS.InvokeVoidAsync("bgm.scrollToTopNextFrame", "smooth");
    }

    private void GoToLogin()
    {
        CloseMenu();
        Navigation.NavigateTo("/login");
    }

    private void GoToRegister()
    {
        CloseMenu();
        Navigation.NavigateTo("/register");
    }
}

