@using Microsoft.AspNetCore.Components.Authorization
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject AuthenticationStateProvider AuthStateProvider
@inject BoardGameMondays.Core.BgmCoinService Coins

@implements IDisposable

<header class="bgm-header" role="banner">
    <div class="bgm-header__inner">
        <a class="bgm-brand"
           href="/#latest"
           aria-label="Board Game Mondays"
           @onclick:preventDefault="true"
           @onclick="OnBrandClick">
            <img class="bgm-brand__logo" src="images/bgm-logo.svg" alt="" />
            <span class="bgm-brand__text">Board Game Mondays</span>
        </a>

        <div class="bgm-header__right">
            <AuthorizeView>
                <Authorized>
                    <div class="bgm-coins" aria-label="BGM Coins">
                        <span class="bgm-coins__label">BGM Coins:</span>
                        <span class="bgm-coins__value">@(_coins?.ToString() ?? "…")</span>
                    </div>
                </Authorized>
            </AuthorizeView>

            <button class="bgm-menuButton"
                    type="button"
                    aria-label="Open menu"
                    aria-controls="bgm-popup"
                    aria-expanded="@_menuOpen"
                    @onclick="ToggleMenu">
                <svg viewBox="0 0 48 48" class="bgm-menuIcon" aria-hidden="true" focusable="false">
                    <path d="M10 14 H38" />
                    <path d="M10 24 H38" />
                    <path d="M10 34 H38" />
                </svg>
            </button>
        </div>
    </div>
</header>

<div class="bgm-backdrop @(_menuOpen ? "is-open" : "")" @onclick="CloseMenu"></div>

<aside id="bgm-popup" class="bgm-popup @(_menuOpen ? "is-open" : "")" role="dialog" aria-modal="true">
    <nav class="bgm-popup__nav" aria-label="Menu">
        <a class="bgm-popup__link" href="/#games" @onclick="CloseMenu">Games</a>
        <a class="bgm-popup__link" href="/#mondays" @onclick="CloseMenu">Mondays</a>
        <a class="bgm-popup__link" href="/#blog" @onclick="CloseMenu">Blog</a>
        <a class="bgm-popup__link" href="/#people" @onclick="CloseMenu">People</a>

        <AuthorizeView>
            <Authorized Context="auth">
                <AuthorizeView Roles="Admin">
                    <Authorized Context="adminAuth">
                        <a class="bgm-popup__link" href="/admin" @onclick="CloseMenu">Admin</a>
                    </Authorized>
                </AuthorizeView>
                <form method="post" action="/account/logout">
                    <AntiforgeryToken />
                    <button type="submit" class="bgm-popup__link bgm-popup__linkButton" @onclick="CloseMenu">Logout</button>
                </form>
            </Authorized>
            <NotAuthorized>
                <button type="button" class="bgm-popup__link bgm-popup__linkButton" @onclick="GoToLogin">Login</button>
                <button type="button" class="bgm-popup__link bgm-popup__linkButton" @onclick="GoToRegister">Sign up</button>
            </NotAuthorized>
        </AuthorizeView>
    </nav>
</aside>

@code {
    private bool _menuOpen;
    private string? _userId;
    private int? _coins;

    protected override async Task OnInitializedAsync()
    {
        AuthStateProvider.AuthenticationStateChanged += OnAuthStateChanged;
        Coins.Changed += OnCoinsChanged;
        await RefreshCoinsAsync();
    }

    public void Dispose()
    {
        AuthStateProvider.AuthenticationStateChanged -= OnAuthStateChanged;
        Coins.Changed -= OnCoinsChanged;
    }

    private void OnAuthStateChanged(Task<AuthenticationState> task)
    {
        _ = InvokeAsync(async () =>
        {
            await task;
            await RefreshCoinsAsync();
        });
    }

    private void OnCoinsChanged()
    {
        _ = InvokeAsync(RefreshCoinsAsync);
    }

    private async Task RefreshCoinsAsync()
    {
        var auth = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = auth.User;

        if (user.Identity?.IsAuthenticated != true)
        {
            _userId = null;
            _coins = null;
            StateHasChanged();
            return;
        }

        _userId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
        if (string.IsNullOrWhiteSpace(_userId))
        {
            _coins = null;
            StateHasChanged();
            return;
        }

        _coins = await Coins.GetCoinsAsync(_userId);
        StateHasChanged();
    }

    private void ToggleMenu() => _menuOpen = !_menuOpen;
    private void CloseMenu() => _menuOpen = false;

    private async Task OnBrandClick()
    {
        CloseMenu();
        Navigation.NavigateTo("/#latest");
        await JS.InvokeVoidAsync("bgm.scrollToTopNextFrame", "smooth");
    }

    private void GoToLogin()
    {
        CloseMenu();
        Navigation.NavigateTo("/login");
    }

    private void GoToRegister()
    {
        CloseMenu();
        Navigation.NavigateTo("/register");
    }
}

