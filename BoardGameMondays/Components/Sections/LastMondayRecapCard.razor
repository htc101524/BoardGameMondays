@using BoardGameMondays.Core
@using BoardGameMondays.Data
@using Microsoft.EntityFrameworkCore
@inject GameNightService GameNightService
@inject BettingService BettingService
@inject RecapStatsService StatsService
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject ShopService ShopService
@if (_isLoading)
{
    <div class="bgm-recapFrame" aria-label="Last Monday recap">
        <div class="card bgm-recapCard">
            <div class="card-body">
                <div class="bgm-mondayRecapTitle">LAST MONDAY RECAP</div>
                <div class="d-flex align-items-center gap-2 text-muted mt-2">
                    <div class="spinner-border spinner-border-sm" role="status" aria-label="Loading"></div>
                    <div>Loading recap...</div>
                </div>
            </div>
        </div>
    </div>
}
else if (_loadFailed)
{
    <div class="bgm-recapFrame" aria-label="Last Monday recap">
        <div class="card bgm-recapCard">
            <div class="card-body">
                <div class="bgm-mondayRecapTitle">LAST MONDAY RECAP</div>
                <div class="text-muted mt-2">Couldn't load the recap yet.</div>
            </div>
        </div>
    </div>
}
else if (_night is null)
{
    <div class="bgm-recapFrame" aria-label="Last Monday recap">
        <div class="card bgm-recapCard">
            <div class="card-body">
                <div class="bgm-mondayRecapTitle">LAST MONDAY RECAP</div>
                <div class="text-muted mt-2">No previous game night found yet.</div>
            </div>
        </div>
    </div>
}
else
{
    <div class="bgm-recapFrame" aria-label="Last Monday recap">
        <div class="card bgm-recapCard">
            <div class="card-body bgm-recapGrid">
                <div class="bgm-recapMainText">
                    <div class="bgm-mondayRecapTitle">LAST MONDAY RECAP</div>
                    <div class="text-muted small">@FormatLongDate(_night.Date)</div>
                    @if (!string.IsNullOrWhiteSpace(_night.Recap))
                    {
                        <div class="bgm-recapSummary">@_night.Recap</div>
                    }
                    @if (_interestingStat is not null)
                    {
                        <div class="bgm-interestingStat">@_interestingStat.Message</div>
                    }
                </div>
                <div class="bgm-recapSidebar">
                    @* Attendees avatars *@
                    @if (_night.Attendees.Count > 0)
                    {
                        <div class="bgm-attendeeSection">
                            <div class="text-muted small mb-1">Who was there</div>
                            <div class="bgm-attendeeAvatars">
                                @foreach (var attendee in _night.Attendees.Take(8))
                                {
                                    var avatarUrl = _memberAvatars.GetValueOrDefault(attendee.MemberId);
                                    var badgeRing = _badgeRings.GetValueOrDefault(attendee.MemberId);
                                    var ringClass = !string.IsNullOrWhiteSpace(badgeRing) ? $"bgm-badgeRing bgm-badgeRing--{badgeRing}" : "";
                                    <div class="@ringClass">
                                        <div class="bgm-recapAvatar" title="@attendee.MemberName">
                                            @if (!string.IsNullOrWhiteSpace(avatarUrl))
                                            {
                                                <img src="@avatarUrl" alt="@attendee.MemberName" />
                                            }
                                            else
                                            {
                                                @GetInitials(attendee.MemberName)
                                            }
                                        </div>
                                    </div>
                                }
                                @if (_night.Attendees.Count > 8)
                                {
                                    <div class="bgm-recapAvatar bgm-recapAvatar--more" title="@(_night.Attendees.Count - 8) more">
                                        +@(_night.Attendees.Count - 8)
                                    </div>
                                }
                            </div>
                        </div>
                    }
                    @* Games played with winners *@
                    @{
                        var playedGames = _night.Games.Where(g => g.IsPlayed).ToArray();
                        var gamesToShow = playedGames.Length > 0 ? playedGames : _night.Games.ToArray();
                    }
                    @if (gamesToShow.Length > 0)
                    {
                        <div class="bgm-gameWinnersList">
                            <div class="text-muted small">Games & Winners</div>
                            @foreach (var g in gamesToShow)
                            {
                                <div class="bgm-gameWinnerItem">
                                    <span class="fw-semibold">@g.GameName</span>
                                    @if (g.Winner is not null)
                                    {
                                        <span class="bgm-winnerBadge">üèÜ @g.Winner.Name</span>
                                    }
                                </div>
                            }
                        </div>
                    }
                </div>
                @* Betting winners/losers - only show if there were bets *@
                @{
                    var winners = _net.Where(x => x.Net > 0).OrderByDescending(x => x.Net).Take(3).ToArray();
                    var losers = _net.Where(x => x.Net < 0).OrderBy(x => x.Net).Take(3).ToArray();
                }
                @if (winners.Length > 0 || losers.Length > 0)
                {
                    <div class="bgm-recapDetails">
                        <div class="col-12 col-md-6">
                            <div class="fw-semibold mb-1">üèÜ Biggest winners</div>
                            @if (winners.Length == 0)
                            {
                                <div class="text-muted">No winning bets.</div>
                            }
                            else
                            {
                                <div class="list-group list-group-flush">
                                    @foreach (var item in winners)
                                    {
                                        <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                                            <div class="text-truncate">@item.DisplayName</div>
                                            <div class="text-success text-nowrap">+@item.Net</div>
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                        <div class="col-12 col-md-6">
                            <div class="fw-semibold mb-1">üò¢ Biggest losers</div>
                            @if (losers.Length == 0)
                            {
                                <div class="text-muted">No losing bets.</div>
                            }
                            else
                            {
                                <div class="list-group list-group-flush">
                                    @foreach (var item in losers)
                                    {
                                        <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                                            <div class="text-truncate">@item.DisplayName</div>
                                            <div class="text-danger text-nowrap">@item.Net</div>
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
}

@code {
    private GameNightService.GameNight? _night;
    private IReadOnlyList<BettingService.NightNetResult> _net = Array.Empty<BettingService.NightNetResult>();
    private RecapStatsService.InterestingStat? _interestingStat;
    private Dictionary<Guid, string?> _memberAvatars = new();
    private Dictionary<Guid, string> _badgeRings = new();
    private bool _isLoading = true;
    private bool _loadFailed;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var today = DateOnly.FromDateTime(DateTime.Today);
            var mondayOnOrBeforeToday = GetMondayOnOrBefore(today);
            var nextMonday = today.DayOfWeek == DayOfWeek.Monday
                ? mondayOnOrBeforeToday
                : mondayOnOrBeforeToday.AddDays(7);

            var latestDates = await GameNightService.GetRecentPastGameNightDatesAsync(nextMonday, take: 1);
            if (latestDates.Count > 0)
            {
                _night = await GameNightService.GetByDateAsync(latestDates[0]);
                if (_night is not null)
                {
                    _net = await BettingService.GetNightNetResultsAsync(_night.Id);
                    _interestingStat = await StatsService.GetInterestingStatAsync(_night.Date);
                    await LoadMemberAvatarsAsync();
                }
            }
        }
        catch
        {
            _loadFailed = true;
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task LoadMemberAvatarsAsync()
    {
        if (_night is null || _night.Attendees.Count == 0)
        {
            return;
        }

        await using var db = await DbFactory.CreateDbContextAsync();
        var memberIds = _night.Attendees.Select(a => a.MemberId).ToList();
        
        var avatars = await db.Members
            .AsNoTracking()
            .Where(m => memberIds.Contains(m.Id))
            .Select(m => new { m.Id, m.AvatarUrl })
            .ToListAsync();

        _memberAvatars = avatars.ToDictionary(a => a.Id, a => a.AvatarUrl);
        
        // Load badge rings for attendees
        var memberUserIds = await db.UserClaims
            .AsNoTracking()
            .Where(c => c.ClaimType == "bgm:memberId" && memberIds.Select(m => m.ToString()).Contains(c.ClaimValue))
            .Select(c => c.UserId)
            .ToListAsync();
        
        foreach (var userId in memberUserIds)
        {
            var badgeRing = await ShopService.GetUserBadgeRingAsync(userId);
            if (!string.IsNullOrWhiteSpace(badgeRing))
            {
                var memberIdClaim = await db.UserClaims
                    .Where(c => c.UserId == userId && c.ClaimType == "bgm:memberId")
                    .Select(c => c.ClaimValue)
                    .FirstOrDefaultAsync();
                
                if (memberIdClaim is not null && Guid.TryParse(memberIdClaim, out var memberId))
                {
                    _badgeRings[memberId] = badgeRing;
                }
            }
        }
    }

    private static DateOnly GetMondayOnOrBefore(DateOnly date)
    {
        var delta = ((int)date.DayOfWeek - (int)DayOfWeek.Monday + 7) % 7;
        return date.AddDays(-delta);
    }

    private static string FormatLongDate(DateOnly date)
        => date.ToString("dddd d MMMM yyyy");

    private static string GetInitials(string name)
    {
        if (string.IsNullOrWhiteSpace(name))
        {
            return "?";
        }

        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
        {
            return $"{parts[0][0]}{parts[^1][0]}".ToUpperInvariant();
        }

        return name.Length >= 2 ? name[..2].ToUpperInvariant() : name.ToUpperInvariant();
    }
}
