@using BoardGameMondays.Core
@inject GameNightService GameNightService
@inject BettingService BettingService
@inject RecapStatsService StatsService

@if (_night is null)
{
    <div class="bgm-recapFrame" aria-label="Last Monday recap">
        <div class="card bgm-recapCard">
            <div class="card-body">
                <div class="bgm-mondayRecapTitle">LAST MONDAY RECAP</div>
                <div class="text-muted mt-2">No previous game night found yet.</div>
            </div>
        </div>
    </div>
}
else
{
    <div class="bgm-recapFrame" aria-label="Last Monday recap">
        <div class="card bgm-recapCard">
            <div class="card-body bgm-recapGrid">
                <div class="bgm-recapMainText">
                    <div class="bgm-mondayRecapTitle">LAST MONDAY RECAP</div>
                    <div class="text-muted small">@FormatLongDate(_night.Date)</div>
                    @if (!string.IsNullOrWhiteSpace(_night.Recap))
                    {
                        <div class="bgm-recapSummary">@_night.Recap</div>
                    }
                    @if (_interestingStat is not null)
                    {
                        <div class="bgm-interestingStat">@_interestingStat.Message</div>
                    }
                </div>
                <div class="bgm-recapSidebar">
                    @* Attendees avatars *@
                    @if (_night.Attendees.Count > 0)
                    {
                        <div class="bgm-attendeeSection">
                            <div class="text-muted small mb-1">Who was there</div>
                            <div class="bgm-attendeeAvatars">
                                @foreach (var attendee in _night.Attendees.Take(8))
                                {
                                    <div class="bgm-attendeeAvatar" title="@attendee.MemberName">
                                        @GetInitials(attendee.MemberName)
                                    </div>
                                }
                                @if (_night.Attendees.Count > 8)
                                {
                                    <div class="bgm-attendeeAvatar bgm-attendeeAvatar--more" title="@(_night.Attendees.Count - 8) more">
                                        +@(_night.Attendees.Count - 8)
                                    </div>
                                }
                            </div>
                        </div>
                    }
                    @* Games played with winners *@
                    @{
                        var playedGames = _night.Games.Where(g => g.IsPlayed).ToArray();
                        var gamesToShow = playedGames.Length > 0 ? playedGames : _night.Games.ToArray();
                    }
                    @if (gamesToShow.Length > 0)
                    {
                        <div class="bgm-gameWinnersList">
                            <div class="text-muted small">Games & Winners</div>
                            @foreach (var g in gamesToShow)
                            {
                                <div class="bgm-gameWinnerItem">
                                    <span class="fw-semibold">@g.GameName</span>
                                    @if (g.Winner is not null)
                                    {
                                        <span class="bgm-winnerBadge">üèÜ @g.Winner.Name</span>
                                    }
                                </div>
                            }
                        </div>
                    }
                </div>
                @* Betting winners/losers - only show if there were bets *@
                @{
                    var winners = _net.Where(x => x.Net > 0).OrderByDescending(x => x.Net).Take(3).ToArray();
                    var losers = _net.Where(x => x.Net < 0).OrderBy(x => x.Net).Take(3).ToArray();
                }
                @if (winners.Length > 0 || losers.Length > 0)
                {
                    <div class="bgm-recapDetails">
                        <div class="col-12 col-md-6">
                            <div class="fw-semibold mb-1">üèÜ Biggest winners</div>
                            @if (winners.Length == 0)
                            {
                                <div class="text-muted">No winning bets.</div>
                            }
                            else
                            {
                                <div class="list-group list-group-flush">
                                    @foreach (var item in winners)
                                    {
                                        <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                                            <div class="text-truncate">@item.DisplayName</div>
                                            <div class="text-success text-nowrap">+@item.Net</div>
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                        <div class="col-12 col-md-6">
                            <div class="fw-semibold mb-1">üò¢ Biggest losers</div>
                            @if (losers.Length == 0)
                            {
                                <div class="text-muted">No losing bets.</div>
                            }
                            else
                            {
                                <div class="list-group list-group-flush">
                                    @foreach (var item in losers)
                                    {
                                        <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                                            <div class="text-truncate">@item.DisplayName</div>
                                            <div class="text-danger text-nowrap">@item.Net</div>
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
}

@code {
    private GameNightService.GameNight? _night;
    private IReadOnlyList<BettingService.NightNetResult> _net = Array.Empty<BettingService.NightNetResult>();
    private RecapStatsService.InterestingStat? _interestingStat;

    protected override async Task OnInitializedAsync()
    {
        var today = DateOnly.FromDateTime(DateTime.Today);
        var mondayOnOrBeforeToday = GetMondayOnOrBefore(today);
        var nextMonday = today.DayOfWeek == DayOfWeek.Monday
            ? mondayOnOrBeforeToday
            : mondayOnOrBeforeToday.AddDays(7);

        var latestDates = await GameNightService.GetRecentPastGameNightDatesAsync(nextMonday, take: 1);
        if (latestDates.Count > 0)
        {
            _night = await GameNightService.GetByDateAsync(latestDates[0]);
            if (_night is not null)
            {
                _net = await BettingService.GetNightNetResultsAsync(_night.Id);
                _interestingStat = await StatsService.GetInterestingStatAsync(_night.Date);
            }
        }
    }

    private static DateOnly GetMondayOnOrBefore(DateOnly date)
    {
        var delta = ((int)date.DayOfWeek - (int)DayOfWeek.Monday + 7) % 7;
        return date.AddDays(-delta);
    }

    private static string FormatLongDate(DateOnly date)
        => date.ToString("dddd d MMMM yyyy");

    private static string GetInitials(string name)
    {
        if (string.IsNullOrWhiteSpace(name))
        {
            return "?";
        }

        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
        {
            return $"{parts[0][0]}{parts[^1][0]}".ToUpperInvariant();
        }

        return name.Length >= 2 ? name[..2].ToUpperInvariant() : name.ToUpperInvariant();
    }
}
