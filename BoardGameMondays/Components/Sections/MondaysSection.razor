@using BoardGameMondays.Core
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using System.Globalization
@inject GameNightService GameNightService
@inject BoardGameService BoardGameService
@inject AuthenticationStateProvider AuthStateProvider
@inject BettingService BettingService
@inject BgmCoinService CoinService
@inject WantToPlayService WantToPlayService
@inject IJSRuntime JS
@inject IHttpContextAccessor HttpContextAccessor
@inject NavigationManager Navigation

@implements IDisposable

<section id="mondays" class="home-section bgm-mondaysSection" aria-label="Mondays" @ref="_mondaysSectionRef">
    <div class="home-section__inner">
        <h1>Mondays</h1>

        <div class="bgm-mondaysScroller" role="list" aria-label="Select a Monday">
            @foreach (var item in _items)
            {
                var isSelected = item.Date == _selected;
                var stateClass = GetMondayStateClass(item.Date);

                <button type="button"
                        class="bgm-mondayCube @stateClass @(isSelected ? "is-selected" : "")"
                        role="listitem"
                        aria-pressed="@isSelected"
                        @onclick="() => SelectAsync(item.Date)">
                    <div class="bgm-mondayCube__dow">Mon</div>
                    <div class="bgm-mondayCube__day">@item.Date.Day</div>
                    <div class="bgm-mondayCube__month">@item.Date.ToString("MMM")</div>
                    <div class="bgm-mondayCube__kind text-muted">@item.Kind</div>
                </button>
            }
        </div>

        <div class="card mt-3 bgm-mondayDetailsCard @GetMondayStateClass(_selected)" aria-label="Selected Monday details">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
                    <div>
                        <div class="fw-semibold">@FormatLongDate(_selected)</div>
                        <div class="text-muted small">@GetMondayKind(_selected)</div>
                    </div>

                    @if (_isAdmin && _selectedNight is null && !_loading)
                    {
                        <button type="button" class="btn btn-sm btn-outline-primary" @onclick="CreateNightAsync">
                            Create game night
                        </button>
                    }
                </div>

                @if (_selected >= _nextMonday)
                {
                    <div class="mt-2 d-flex align-items-center gap-2 flex-wrap" aria-label="Share RSVP link">
                        <a class="btn btn-sm btn-outline-secondary" href="@GetRsvpLink(_selected)">Open RSVP page</a>
                        <button type="button" class="btn btn-sm btn-outline-secondary" @onclick="CopyRsvpLinkAsync">Copy RSVP link</button>

                        @if (!string.IsNullOrWhiteSpace(_shareStatus))
                        {
                            <span class="text-muted small">@_shareStatus</span>
                        }
                    </div>
                }

                @if (_loading)
                {
                    <div class="text-muted mt-3">Loadingâ€¦</div>
                }
                else if (_selectedNight is null)
                {
                    <div class="text-muted mt-3">There wasn't a game night on this Monday.</div>
                }
                else
                {
                    @if (_isAdmin && _selected >= _nextMonday)
                    {
                        <div class="mt-3" aria-label="Attendance">
                            @if (_memberId is null)
                            {
                                <div class="text-muted">Your account isn't linked to a BGM member yet.</div>
                            }
                            else
                            {
                                <div class="d-flex align-items-center gap-2 flex-wrap">
                                    <span class="fw-semibold">Attending?</span>

                                    <button type="button"
                                            class="btn btn-sm @(_amAttending ? "btn-success" : "btn-outline-success")"
                                            disabled="@_saving"
                                            @onclick="() => SetAttendingAsync(true)">
                                        âœ“
                                    </button>
                                    <button type="button"
                                            class="btn btn-sm @(!_amAttending ? "btn-danger" : "btn-outline-danger")"
                                            disabled="@_saving"
                                            @onclick="() => SetAttendingAsync(false)">
                                        âœ•
                                    </button>

                                    @if (!string.IsNullOrWhiteSpace(_status))
                                    {
                                        <span class="text-muted">@_status</span>
                                    }
                                </div>
                            }
                        </div>
                    }

                    <div class="mt-3" aria-label="Attendees">
                        <div class="fw-semibold mb-1">People going</div>
                        @if (_selectedNight.Attendees.Count == 0)
                        {
                            <div class="text-muted">No attendees yet.</div>
                        }
                        else
                        {
                            <div class="d-flex flex-wrap gap-2">
                                @foreach (var attendee in _selectedNight.Attendees)
                                {
                                    <span class="badge text-bg-light">@attendee.MemberName</span>

                                    @if (_isAdmin && _selected < _nextMonday)
                                    {
                                        <button type="button"
                                                class="btn btn-sm btn-outline-danger"
                                                disabled="@_saving"
                                                title="Remove"
                                                aria-label="Remove @attendee.MemberName"
                                                @onclick="() => SetMemberAttendanceAsync(attendee.MemberId, false)">
                                            âœ•
                                        </button>
                                    }
                                }
                            </div>
                        }

                        @if (_isAdmin && _selected < _nextMonday)
                        {
                            <div class="mt-2 d-flex align-items-center gap-2 flex-wrap" aria-label="Add attendee">
                                <select class="form-select form-select-sm" style="max-width: 360px" @bind="_selectedMemberId">
                                    <option value="">Add a memberâ€¦</option>
                                    @foreach (var m in _allMembers.Where(m => !_selectedNight.Attendees.Any(a => a.MemberId == m.Id) && !_declinedMemberIds.Contains(m.Id)))
                                    {
                                        <option value="@m.Id">@m.Name</option>
                                    }
                                </select>
                                <button type="button" class="btn btn-sm btn-outline-primary" disabled="@_saving" @onclick="AddSelectedMemberAsync">
                                    Add
                                </button>
                            </div>
                        }
                    </div>

                    @if (_selected < _nextMonday)
                    {
                        <div class="mt-3" aria-label="Snacks brought">
                            <div class="fw-semibold mb-1">Snacks brought</div>
                            @if (_selectedNight.Attendees.Count == 0)
                            {
                                <div class="text-muted">No attendees yet.</div>
                            }
                            else
                            {
                                <div class="d-grid gap-2">
                                    @foreach (var attendee in _selectedNight.Attendees)
                                    {
                                        var status = _snackStatusByMemberId.TryGetValue(attendee.MemberId, out var s) ? s : null;

                                        <div class="d-flex align-items-center gap-2 flex-wrap">
                                            <div style="min-width: 160px" class="fw-semibold">@attendee.MemberName</div>

                                            @if (_isAdmin)
                                            {
                                                <input type="text"
                                                       class="form-control form-control-sm"
                                                       style="min-width: 240px; max-width: 420px"
                                                       placeholder="â€”"
                                                       value="@GetSnackDraft(attendee.MemberId)"
                                                       disabled="@_saving"
                                                       @onchange="e => SetSnackDraft(attendee.MemberId, e.Value?.ToString())" />

                                                <button type="button"
                                                        class="btn btn-sm btn-outline-primary"
                                                        disabled="@_saving"
                                                        @onclick="() => SaveSnackAsync(attendee.MemberId)">
                                                    Save
                                                </button>

                                                @if (!string.IsNullOrWhiteSpace(status))
                                                {
                                                    <span class="text-muted small">@status</span>
                                                }
                                            }
                                            else
                                            {
                                                <div class="fw-semibold">@(string.IsNullOrWhiteSpace(attendee.SnackBrought) ? "â€”" : attendee.SnackBrought)</div>
                                            }
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    }

                    <div class="mt-3" aria-label="Planned games">
                        <div class="fw-semibold mb-1">@(_selected < _nextMonday ? "Games played" : "Games planned")</div>
                        @if (_selectedNight.Games.Count == 0)
                        {
                            <div class="text-muted">No planned games yet.</div>
                        }
                        else
                        {
                            <div class="d-grid gap-2">
                                @foreach (var game in _selectedNight.Games)
                                {
                                    <div id="mondays-game-@game.Id" class="border rounded p-2 bgm-mondayGameCard" aria-label="Game">
                                        <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
                                            <div class="fw-semibold">@game.GameName</div>

                                            @if (game.IsConfirmed)
                                            {
                                                <span class="badge text-bg-primary">Confirmed</span>
                                            }
                                            else if (_isAdmin)
                                            {
                                                <button type="button"
                                                        class="btn btn-sm btn-primary"
                                                        disabled="@_saving"
                                                        @onclick="() => ConfirmGameAsync(game.Id)">
                                                    Confirm
                                                </button>
                                            }

                                            @if (_isAdmin && !game.IsConfirmed)
                                            {
                                                <button type="button"
                                                        class="btn btn-sm btn-outline-danger"
                                                        disabled="@_saving"
                                                        title="Remove this game from the night"
                                                        @onclick="() => RemoveGameAsync(game.Id)">
                                                    Remove
                                                </button>
                                            }

                                            @if (game.Winner is not null)
                                            {
                                                <span class="badge text-bg-success">Winner: @game.Winner.Name</span>
                                            }
                                            else if (game.IsPlayed && game.Winner is null)
                                            {
                                                <span class="badge text-bg-success">Winner: Everyone lost</span>
                                            }
                                        </div>

                                        <div class="mt-2" aria-label="Players">
                                            <div class="d-flex justify-content-between align-items-center mb-1">
                                                <div class="text-muted small">Players</div>
                                                @if (_isAdmin && !game.IsConfirmed && !IsTeamMode(game))
                                                {
                                                    <button type="button"
                                                            class="btn btn-sm btn-outline-secondary"
                                                            disabled="@_saving"
                                                            title="Switch this game to team-based mode (players will be cleared so you can add them into teams)"
                                                            @onclick="() => EnableTeamModeAsync(game.Id)">
                                                        Set as Team-Based
                                                    </button>
                                                }
                                            </div>

                                            @if (!IsTeamMode(game) && game.Players.Count == 0)
                                            {
                                                <div class="text-muted">No players yet.</div>
                                            }
                                            else if (IsTeamMode(game))
                                            {
                                                <div class="bgm-teamsGrid" aria-label="Teams">
                                                    @foreach (var team in GetTeams(game).Concat(_clientTeams.TryGetValue(game.Id, out var _ct) ? _ct : Enumerable.Empty<string>()))
                                                    {
                                                        var teamPlayers = game.Players.Where(p => string.Equals(p.TeamName, team, StringComparison.OrdinalIgnoreCase)).ToArray();
                                                        if (teamPlayers.Length == 0)
                                                        {
                                                            // show empty client-side teams even if there are no players
                                                            if (!(_clientTeams.TryGetValue(game.Id, out var ct) && ct.Contains(team)))
                                                            {
                                                                continue;
                                                            }
                                                        }

                                                        var colorHex = GetTeamColor(game, team);
                                                        var textColor = GetContrastingText(colorHex);
                                                        var isClientTeam = _clientTeams.TryGetValue(game.Id, out var _ct2) && _ct2.Contains(team);
                                                        var removeBorder = ShouldRemoveTeamBorder(colorHex);

                                                        <div class="bgm-teamBubble @(removeBorder ? "bgm-teamBubble--noBorder" : "")" aria-label="Team" style="@(colorHex is null ? string.Empty : $"background-color: {colorHex}; color: {textColor};")">
                                                            <div class="bgm-teamBubble__header">
                                                                @if (isClientTeam && _isAdmin && !game.IsConfirmed)
                                                                {
                                                                    <input class="form-control form-control-sm" value="@team" @onchange="e => RenameClientTeam(game.Id, team, e.Value?.ToString())" />
                                                                }
                                                                else
                                                                {
                                                                    <div class="fw-semibold">@team</div>
                                                                }

                                                            </div>

                                                            <div class="bgm-teamBubble__players" aria-label="Players">
                                                                @foreach (var player in teamPlayers)
                                                                {
                                                                    <div class="bgm-teamBubble__playerRow">
                                                                        <span class="bgm-teamBubble__playerName">@player.MemberName</span>

                                                                        @if (_isAdmin && !game.IsConfirmed)
                                                                        {
                                                                            <button type="button"
                                                                                    class="btn btn-sm btn-outline-danger"
                                                                                    disabled="@_saving"
                                                                                    title="Remove"
                                                                                    aria-label="Remove @player.MemberName"
                                                                                    @onclick="() => RemovePlayerAsync(game.Id, player.MemberId)">
                                                                                âœ•
                                                                            </button>
                                                                        }
                                                                    </div>
                                                                }
                                                            </div>

                                                            @if (_isAdmin && !game.IsConfirmed)
                                                            {
                                                                <div class="bgm-teamBubble__footer" aria-label="Add player">
                                                                    <select class="form-select form-select-sm"
                                                                            value="@GetSelectedTeamPlayer(game.Id, team)"
                                                                            @onchange="e => SetSelectedTeamPlayer(game.Id, team, e.Value?.ToString())">
                                                                        <option value="">Add attending playerâ€¦</option>
                                                                        @foreach (var attendee in _selectedNight.Attendees.Where(a => !game.Players.Any(p => p.MemberId == a.MemberId)))
                                                                        {
                                                                            <option value="@attendee.MemberId">@attendee.MemberName</option>
                                                                        }
                                                                    </select>
                                                                    <button type="button"
                                                                            class="btn btn-sm btn-outline-primary"
                                                                            disabled="@_saving"
                                                                            @onclick="() => AddSelectedPlayerToTeamAsync(game.Id, team)">
                                                                        Add
                                                                    </button>
                                                                </div>

                                                                <div class="bgm-teamBubble__colorRow" aria-label="Choose colour">
                                                                    <div class="text-muted small">Choose colour:</div>
                                                                    <input type="color"
                                                                           class="form-control form-control-color form-control-sm"
                                                                           value="@(NormalizeColor(colorHex ?? _mondaysSectionBackgroundHex))"
                                                                           disabled="@_saving"
                                                                           @onchange="e => ChangeTeamColorAsync(game.Id, team, e.Value?.ToString())" />
                                                                </div>
                                                            }

                                                            @if (game.IsConfirmed && _selected >= _nextMonday)
                                                            {
                                                                var rep = teamPlayers[0];
                                                                var odds = game.Odds.FirstOrDefault(o => teamPlayers.Any(tp => tp.MemberId == o.MemberId))?.OddsTimes100;

                                                                <div class="bgm-teamBubble__odds" aria-label="Odds">
                                                                    <div class="text-muted small fw-semibold">Odds</div>
                                                                    <div><span class="bgm-oddsValue">@FormatFraction(odds)</span></div>
                                                                </div>
                                                            }
                                                        </div>
                                                    }

                                                    @{ var soloPlayers = game.Players.Where(p => string.IsNullOrWhiteSpace(p.TeamName)).ToArray(); }
                                                    @if (soloPlayers.Length > 0)
                                                    {
                                                        <div class="bgm-teamBubble" aria-label="No team">
                                                            <div class="bgm-teamBubble__header fw-semibold">No team</div>
                                                            <div class="bgm-teamBubble__players" aria-label="Players">
                                                                @foreach (var player in soloPlayers)
                                                                {
                                                                    <div class="bgm-teamBubble__playerRow">
                                                                        <span class="bgm-teamBubble__playerName">@player.MemberName</span>

                                                                        @if (_isAdmin && !game.IsConfirmed)
                                                                        {
                                                                            <button type="button"
                                                                                    class="btn btn-sm btn-outline-danger"
                                                                                    disabled="@_saving"
                                                                                    title="Remove"
                                                                                    aria-label="Remove @player.MemberName"
                                                                                    @onclick="() => RemovePlayerAsync(game.Id, player.MemberId)">
                                                                                âœ•
                                                                            </button>
                                                                        }
                                                                    </div>
                                                                }
                                                            </div>
                                                        </div>
                                                    }

                                                    @if (_isAdmin && !game.IsConfirmed)
                                                    {
                                                        <div class="bgm-teamBubble bgm-teamBubble--add" aria-label="Add team">
                                                            <button type="button"
                                                                    class="bgm-teamBubble__addButton"
                                                                    disabled="@_saving"
                                                                    title="Add empty team"
                                                                    @onclick="() => AddEmptyTeamAsync(game.Id)">
                                                                +
                                                            </button>

                                                            <div class="mt-2">
                                                                <select class="form-select form-select-sm"
                                                                        value="@GetSelectedPlayer(game.Id)"
                                                                        @onchange="e => SetSelectedPlayer(game.Id, e.Value?.ToString())">
                                                                    <option value="">Create team with attendeeâ€¦</option>
                                                                    @foreach (var attendee in _selectedNight.Attendees.Where(a => !game.Players.Any(p => p.MemberId == a.MemberId)))
                                                                    {
                                                                        <option value="@attendee.MemberId">@attendee.MemberName</option>
                                                                    }
                                                                </select>
                                                            </div>
                                                        </div>
                                                    }
                                                </div>
                                            }
                                            else
                                            {
                                                <div class="d-flex flex-wrap gap-2 align-items-center">
                                                    @foreach (var player in game.Players)
                                                    {
                                                        <span class="badge text-bg-light">@player.MemberName</span>

                                                        @if (_isAdmin && !game.IsConfirmed)
                                                        {
                                                            <button type="button"
                                                                    class="btn btn-sm btn-outline-danger"
                                                                    disabled="@_saving"
                                                                    title="Remove"
                                                                    aria-label="Remove @player.MemberName"
                                                                    @onclick="() => RemovePlayerAsync(game.Id, player.MemberId)">
                                                                âœ•
                                                            </button>
                                                        }
                                                    }
                                                </div>
                                            }

                                            @if (_isAdmin && !game.IsConfirmed && !IsTeamMode(game))
                                            {
                                                <div class="mt-2 d-flex align-items-center gap-2 flex-wrap" aria-label="Add player">
                                                    <select class="form-select form-select-sm" style="max-width: 360px"
                                                            value="@GetSelectedPlayer(game.Id)"
                                                            @onchange="e => SetSelectedPlayer(game.Id, e.Value?.ToString())">
                                                        <option value="">Add an attendeeâ€¦</option>
                                                        @foreach (var attendee in _selectedNight.Attendees)
                                                        {
                                                            <option value="@attendee.MemberId">@attendee.MemberName</option>
                                                        }
                                                    </select>
                                                    <button type="button" class="btn btn-sm btn-outline-primary" disabled="@_saving" @onclick="() => AddSelectedPlayerAsync(game.Id)">
                                                        Add
                                                    </button>
                                                </div>
                                            }
                                        </div>

                                        @if (game.IsConfirmed && _selected >= _nextMonday && !IsTeamMode(game))
                                        {
                                            <div class="mt-2" aria-label="Odds">
                                                <div class="text-muted small mb-1">
                                                    <span role="img" aria-label="Money">ðŸ’°</span> Markets
                                                </div>

                                                @if (game.Players.Count == 0)
                                                {
                                                    <div class="text-muted">Add players first.</div>
                                                }
                                                else
                                                {
                                                    <div class="d-grid gap-1 bgm-markets">
                                                        @{
                                                            if (HasTeams(game))
                                                            {
                                                                var teams = GetTeams(game);
                                                                foreach (var team in teams)
                                                                {
                                                                    var teamPlayers = game.Players.Where(p => string.Equals(p.TeamName, team, StringComparison.OrdinalIgnoreCase)).ToArray();
                                                                    if (teamPlayers.Length == 0)
                                                                    {
                                                                        continue;
                                                                    }

                                                                    var odds = game.Odds.FirstOrDefault(o => teamPlayers.Any(tp => tp.MemberId == o.MemberId))?.OddsTimes100;

                                                                    <div class="d-flex justify-content-between align-items-center bgm-oddsSlipRow">
                                                                        <div class="text-truncate">@team</div>
                                                                        <div><span class="bgm-oddsValue">@FormatFraction(odds)</span></div>
                                                                    </div>
                                                                }
                                                            }
                                                            else
                                                            {
                                                                foreach (var p in game.Players)
                                                                {
                                                                    var odds = game.Odds.FirstOrDefault(o => o.MemberId == p.MemberId)?.OddsTimes100;

                                                                    <div class="d-flex justify-content-between align-items-center bgm-oddsSlipRow">
                                                                        <div class="text-truncate">@p.MemberName</div>
                                                                        <div><span class="bgm-oddsValue">@FormatFraction(odds)</span></div>
                                                                    </div>
                                                                }
                                                            }
                                                        }
                                                    </div>
                                                }
                                            </div>

                                            <div class="mt-3" aria-label="Betting">
                                                <AuthorizeView>
                                                    <NotAuthorized>
                                                        <div class="text-muted">Log in to place a bet.</div>
                                                    </NotAuthorized>
                                                    <Authorized>
                                                        @if (_myBets.TryGetValue(game.Id, out var bet))
                                                        {
                                                            <div class="text-muted">
                                                                You bet @bet.Amount on @bet.WinnerMemberName (odds @FormatFraction(bet.OddsTimes100)).
                                                                @{
                                                                    var profit = ComputeProfit(bet.Amount, bet.OddsTimes100);
                                                                    if (profit is not null)
                                                                    {
                                                                        <span>Potential winnings: +@profit (return @(bet.Amount + profit.Value)).</span>
                                                                    }
                                                                }
                                                            </div>
                                                        }
                                                        else
                                                        {
                                                            <div class="d-flex align-items-center gap-2 flex-wrap">
                                                                <span class="fw-semibold">Bet</span>

                                                                <select class="form-select form-select-sm" style="max-width: 260px"
                                                                        value="@GetSelectedBetWinner(game.Id)"
                                                                        @onchange="e => SetSelectedBetWinner(game.Id, e.Value?.ToString())">
                                                                    <option value="">Pick a winnerâ€¦</option>
                                                                    @if (HasTeams(game))
                                                                    {
                                                                        var teams = GetTeams(game);
                                                                        foreach (var team in teams)
                                                                        {
                                                                            var teamPlayers = game.Players.Where(p => string.Equals(p.TeamName, team, StringComparison.OrdinalIgnoreCase)).ToArray();
                                                                            if (teamPlayers.Length == 0)
                                                                            {
                                                                                continue;
                                                                            }

                                                                            var rep = teamPlayers[0];
                                                                            var hasOdds = game.Odds.Any(o => teamPlayers.Any(tp => tp.MemberId == o.MemberId));
                                                                            <option value="@rep.MemberId" disabled="@(!hasOdds)">
                                                                                @team@(hasOdds ? string.Empty : " (no odds)")
                                                                            </option>
                                                                        }
                                                                    }
                                                                    else
                                                                    {
                                                                        foreach (var p in game.Players)
                                                                        {
                                                                            var hasOdds = game.Odds.Any(o => o.MemberId == p.MemberId);
                                                                            <option value="@p.MemberId" disabled="@(!hasOdds)">
                                                                                @p.MemberName@(hasOdds ? string.Empty : " (no odds)")
                                                                            </option>
                                                                        }
                                                                    }
                                                                </select>

                                                                <input type="number"
                                                                       class="form-control form-control-sm"
                                                                       style="max-width: 120px"
                                                                       min="1"
                                                                       step="1"
                                                                       value="@GetSelectedBetAmount(game.Id)"
                                                                       disabled="@_saving"
                                                                       @onchange="e => SetSelectedBetAmount(game.Id, e.Value?.ToString())" />

                                                                <button type="button"
                                                                        class="btn btn-sm btn-success"
                                                                        disabled="@_saving"
                                                                        @onclick="() => PlaceBetAsync(game.Id)">
                                                                    Place bet
                                                                </button>

                                                                <span class="text-muted">Balance: @(_coins?.ToString() ?? "â€¦")</span>

                                                                @{
                                                                    var profit = GetSelectedProfit(game);
                                                                    if (profit is not null)
                                                                    {
                                                                        <span class="text-muted">Potential winnings: +@profit (return @((GetSelectedAmount(game.Id) + profit.Value))).</span>
                                                                    }
                                                                }

                                                                @if (_betStatusByGameId.TryGetValue(game.Id, out var message) && !string.IsNullOrWhiteSpace(message))
                                                                {
                                                                    <span class="text-muted">@message</span>
                                                                }
                                                            </div>
                                                        }
                                                    </Authorized>
                                                </AuthorizeView>
                                            </div>
                                        }

                                        @if (_isAdmin && _selected < _nextMonday)
                                        {
                                            <div class="mt-2" aria-label="Winner">
                                                <div class="text-muted small mb-1">Winner</div>
                                                <div class="d-flex align-items-center gap-2 flex-wrap">
                                                    @if (HasTeams(game))
                                                    {
                                                        // For games with bets, IsSettled indicates result was confirmed
                                                        // For games without bets, IsPlayed indicates result was confirmed (set by SetWinnerAsync)
                                                        // Note: IsPlayed is only set when winner is confirmed, not when game is added
                                                        var isTeamNoWinnerConfirmed = game.IsPlayed && game.Winner is null;
                                                        var isTeamWinnerConfirmed = game.HasBets ? game.IsSettled : (game.Winner is not null || isTeamNoWinnerConfirmed);
                                                        var teamActualValue = game.Winner?.IsTeam == true 
                                                            ? (game.Winner?.Name ?? string.Empty) 
                                                            : (isTeamWinnerConfirmed ? "" : "NOT_SET");
                                                        var teamCurrentSelection = _pendingTeamWinnerSelectionByGameId.TryGetValue(game.Id, out var teamPending) 
                                                            ? teamPending 
                                                            : teamActualValue;
                                                        var teamHasChanged = teamCurrentSelection != teamActualValue;
                                                        var isTeamDropdownDisabled = _saving || !game.IsConfirmed || (game.HasBets && game.IsSettled) || isTeamNoWinnerConfirmed;
                                                        <select class="form-select form-select-sm" style="max-width: 360px"
                                                                value="@teamCurrentSelection"
                                                                disabled="@isTeamDropdownDisabled"
                                                                @onchange="e => OnTeamWinnerSelectionChanged(game.Id, e.Value?.ToString())">
                                                            <option value="NOT_SET">Not Set</option>
                                                            <option value="">No winner</option>
                                                            @foreach (var team in GetTeams(game))
                                                            {
                                                                <option value="@team">@team</option>
                                                            }
                                                        </select>
                                                        
                                                        @if (teamHasChanged)
                                                        {
                                                            <button type="button"
                                                                    class="btn btn-sm btn-primary ms-2"
                                                                    disabled="@_saving"
                                                                    @onclick="() => ConfirmTeamWinnerSelectionAsync(game.Id)">
                                                                Confirm Winner
                                                            </button>
                                                            <button type="button"
                                                                    class="btn btn-sm btn-outline-secondary ms-1"
                                                                    disabled="@_saving"
                                                                    @onclick="() => CancelTeamWinnerSelection(game.Id)">
                                                                Cancel
                                                            </button>
                                                        }
                                                    }
                                                    else
                                                    {
                                                        // For games with bets, IsSettled indicates result was confirmed
                                                        // For games without bets, IsPlayed indicates result was confirmed (set by SetWinnerAsync)
                                                        // Note: IsPlayed is only set when winner is confirmed, not when game is added
                                                        var isNoWinnerConfirmed = game.IsPlayed && game.Winner is null;
                                                        var isWinnerConfirmed = game.HasBets ? game.IsSettled : (game.Winner is not null || isNoWinnerConfirmed);
                                                        var actualValue = game.Winner?.MemberId?.ToString() 
                                                            ?? (isWinnerConfirmed ? "" : "NOT_SET");
                                                        var currentSelection = _pendingWinnerSelectionByGameId.TryGetValue(game.Id, out var pending) 
                                                            ? pending 
                                                            : actualValue;
                                                        var hasChanged = currentSelection != actualValue;
                                                        var isDropdownDisabled = _saving || !game.IsConfirmed || (game.HasBets && game.IsSettled) || isNoWinnerConfirmed;
                                                        <select class="form-select form-select-sm" style="max-width: 360px"
                                                                value="@currentSelection"
                                                                disabled="@isDropdownDisabled"
                                                                @onchange="e => OnWinnerSelectionChanged(game.Id, e.Value?.ToString())">
                                                            <option value="NOT_SET">Not Set</option>
                                                            <option value="">No winner</option>
                                                            @foreach (var p in game.Players)
                                                            {
                                                                <option value="@p.MemberId">@p.MemberName</option>
                                                            }
                                                        </select>
                                                        
                                                        @if (hasChanged)
                                                        {
                                                            <button type="button"
                                                                    class="btn btn-sm btn-primary ms-2"
                                                                    disabled="@_saving"
                                                                    @onclick="() => ConfirmWinnerSelectionAsync(game.Id)">
                                                                Confirm Winner
                                                            </button>
                                                            <button type="button"
                                                                    class="btn btn-sm btn-outline-secondary ms-1"
                                                                    disabled="@_saving"
                                                                    @onclick="() => CancelWinnerSelection(game.Id)">
                                                                Cancel
                                                            </button>
                                                        }
                                                    }

                                                    @{
                                                        // Show settled/confirm UI for games with a winner OR games with confirmed result
                                                        // IsPlayed indicates result was confirmed (including No Winner)
                                                        var hasConfirmedNoWinner = game.IsPlayed && game.Winner is null;
                                                        var showResultStatus = game.Winner is not null || game.IsSettled || hasConfirmedNoWinner;
                                                    }
                                                    @if (showResultStatus)
                                                    {
                                                        @if (game.IsSettled)
                                                        {
                                                            <span class="badge text-bg-success">Settled</span>
                                                        }
                                                        else if (game.Winner is null && hasConfirmedNoWinner)
                                                        {
                                                            @* No Winner result confirmed - show appropriate status *@
                                                            @if (game.HasBets)
                                                            {
                                                                @if (_confirmWinnerPending.Contains(game.Id))
                                                                {
                                                                    <button type="button"
                                                                            class="btn btn-sm btn-danger"
                                                                            disabled="@_saving"
                                                                            @onclick="() => ConfirmWinnerAsync(game.Id)">
                                                                        Are you sure?
                                                                    </button>
                                                                    <button type="button"
                                                                            class="btn btn-sm btn-outline-secondary"
                                                                            disabled="@_saving"
                                                                            @onclick="() => CancelConfirmWinner(game.Id)">
                                                                        Cancel
                                                                    </button>
                                                                }
                                                                else
                                                                {
                                                                    <button type="button"
                                                                            class="btn btn-sm btn-success"
                                                                            disabled="@_saving"
                                                                            @onclick="() => BeginConfirmWinner(game.Id)">
                                                                        Settle bets
                                                                    </button>
                                                                }

                                                                @if (_settleStatusByGameId.TryGetValue(game.Id, out var noWinnerStatus) && !string.IsNullOrWhiteSpace(noWinnerStatus))
                                                                {
                                                                    <span class="text-muted">@noWinnerStatus</span>
                                                                }
                                                            }
                                                            else
                                                            {
                                                                <span class="badge text-bg-success">Settled</span>
                                                            }
                                                        }
                                                        else
                                                        {
                                                            @if (game.HasBets)
                                                            {
                                                                @if (_confirmWinnerPending.Contains(game.Id))
                                                                {
                                                                    <button type="button"
                                                                            class="btn btn-sm btn-danger"
                                                                            disabled="@_saving"
                                                                            @onclick="() => ConfirmWinnerAsync(game.Id)">
                                                                        Are you sure?
                                                                    </button>
                                                                    <button type="button"
                                                                            class="btn btn-sm btn-outline-secondary"
                                                                            disabled="@_saving"
                                                                            @onclick="() => CancelConfirmWinner(game.Id)">
                                                                        Cancel
                                                                    </button>
                                                                }
                                                                else
                                                                {
                                                                    <button type="button"
                                                                            class="btn btn-sm btn-success"
                                                                            disabled="@_saving"
                                                                            @onclick="() => BeginConfirmWinner(game.Id)">
                                                                        Confirm
                                                                    </button>
                                                                }

                                                                @if (_settleStatusByGameId.TryGetValue(game.Id, out var status) && !string.IsNullOrWhiteSpace(status))
                                                                {
                                                                    <span class="text-muted">@status</span>
                                                                }
                                                            }
                                                            else
                                                            {
                                                                <span class="badge text-bg-secondary">No bets</span>
                                                            }
                                                        }
                                                    }
                                                </div>

                                                @if (game.Winner is not null)
                                                {
                                                    <div class="mt-2">
                                                        <button type="button"
                                                                class="btn btn-sm btn-outline-secondary"
                                                                disabled="@_saving"
                                                                @onclick="() => ToggleVictoryRoutesAsync(game)">
                                                            How did they win?
                                                        </button>

                                                        @if (_victoryRouteStatusByGameId.TryGetValue(game.Id, out var vrStatus) && !string.IsNullOrWhiteSpace(vrStatus))
                                                        {
                                                            <span class="text-muted ms-2">@vrStatus</span>
                                                        }
                                                    </div>

                                                    @if (_victoryRoutesOpen.Contains(game.Id))
                                                    {
                                                        var routes = GetVictoryRoutes(game.Id);
                                                        if (routes.Count == 0)
                                                        {
                                                            <div class="text-muted mt-2">No routes configured for this game.</div>
                                                        }
                                                        else
                                                        {
                                                            <div class="border rounded p-2 mt-2 bg-body" aria-label="Victory routes">
                                                                <div class="fw-semibold mb-2">How did they win?</div>

                                                                <div class="d-grid gap-2">
                                                                    @foreach (var route in routes)
                                                                    {
                                                                        <div class="d-flex gap-2 align-items-center flex-wrap">
                                                                            <div style="min-width: 180px" class="text-muted">@route.Name</div>

                                                                            @if (route.Type == VictoryRouteType.Dropdown)
                                                                            {
                                                                                <select class="form-select form-select-sm" style="max-width: 360px"
                                                                                        value="@GetVictoryRouteString(game.Id, route.Id)"
                                                                                        disabled="@_saving"
                                                                                        @onchange="e => SetVictoryRouteString(game.Id, route.Id, e.Value?.ToString())">
                                                                                    <option value="">â€”</option>
                                                                                    @foreach (var opt in route.Options)
                                                                                    {
                                                                                        <option value="@opt.Value">@opt.Value</option>
                                                                                    }
                                                                                </select>
                                                                            }
                                                                            else if (route.Type == VictoryRouteType.Checkbox)
                                                                            {
                                                                                <div class="form-check">
                                                                                    <input class="form-check-input" type="checkbox"
                                                                                           checked="@GetVictoryRouteBool(game.Id, route.Id)"
                                                                                           disabled="@_saving"
                                                                                           @onchange="e => SetVictoryRouteBool(game.Id, route.Id, e.Value?.ToString())" />
                                                                                </div>
                                                                            }
                                                                        </div>
                                                                    }
                                                                </div>

                                                                <div class="mt-2">
                                                                    <button type="button" class="btn btn-sm btn-outline-primary" disabled="@_saving" @onclick="() => SaveVictoryRoutesAsync(game)">Save</button>
                                                                </div>
                                                            </div>
                                                        }
                                                    }
                                                }
                                            </div>
                                        }
                                    </div>
                                }
                            </div>
                        }

                        @if (_isAdmin)
                        {
                            <div class="mt-2 d-flex align-items-center gap-2 flex-wrap">
                                <select class="form-select form-select-sm" style="max-width: 360px" @bind="_selectedGameId">
                                    <option value="">Add an existing gameâ€¦</option>
                                    @foreach (var g in _allGames)
                                    {
                                        <option value="@g.Id">@g.Name</option>
                                    }
                                </select>
                                <button type="button" class="btn btn-sm btn-outline-primary" disabled="@_saving" @onclick="AddPlannedGameAsync">
                                    Add
                                </button>
                            </div>
                        }
                    </div>

                    @if (_selected < _nextMonday)
                    {
                        <div class="mt-3" aria-label="Recap">
                            <div class="fw-semibold mb-1">Recap</div>

                            @if (_isAdmin)
                            {
                                <textarea class="form-control" rows="3" placeholder="One sentence about what happenedâ€¦" @bind="_recapEdit" disabled="@_savingRecap"></textarea>
                                <div class="mt-2 d-flex align-items-center gap-2 flex-wrap">
                                    <button type="button" class="btn btn-sm btn-outline-primary" disabled="@_savingRecap" @onclick="SaveRecapAsync">Save recap</button>
                                    @if (!string.IsNullOrWhiteSpace(_recapStatus))
                                    {
                                        <span class="text-muted">@_recapStatus</span>
                                    }
                                </div>
                            }
                            else if (!string.IsNullOrWhiteSpace(_selectedNight.Recap))
                            {
                                <div>@_selectedNight.Recap</div>
                            }
                            else
                            {
                                <div class="text-muted">No recap yet.</div>
                            }
                        </div>
                    }
                }
            </div>
        </div>

        <div class="card mt-3 bgm-wantToPlayCard" aria-label="Most wanted games">
            <div class="card-body">
                <div class="fw-semibold mb-2">Most wanted to play</div>

                @if (_mostWanted.Count == 0)
                {
                    <div class="text-muted">No votes yet.</div>
                }
                else
                {
                    <div class="list-group list-group-flush">
                        @foreach (var item in _mostWanted)
                        {
                            <div class="list-group-item d-flex align-items-center justify-content-between px-0">
                                <div class="d-flex align-items-center gap-2">
                                    <img class="bgm-wantToPlayThumb" src="@(item.ImageUrl ?? "images/placeholder-game-cover.svg")" alt="" />
                                    <div class="fw-semibold">@item.Name</div>
                                </div>
                                <span class="badge text-bg-light">@item.Votes vote@(item.Votes == 1 ? "" : "s")</span>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
    </div>
</section>

@code {
    private const int PastCountAdmin = 8;
    private const int UpcomingCount = 8;

    private readonly List<MondayItem> _items = new();
    private readonly List<GameOption> _allGames = new();
    private readonly List<GameNightService.MemberOption> _allMembers = new();

    private DateOnly _selected;
    private DateOnly _nextMonday;
    private DateOnly? _lastPastMonday;

    private bool _isAdmin;
    private string? _userId;
    private int? _coins;
    private Guid? _memberId;

    private string _recapEdit = string.Empty;
    private bool _savingRecap;
    private string? _recapStatus;

    private GameNightService.GameNight? _selectedNight;
    private bool _loading;
    private bool _saving;
    private string? _status;
    private bool _amAttending;
    private HashSet<Guid> _declinedMemberIds = new();
    private string? _shareStatus;
    private string? _selectedGameId;
    private string? _selectedMemberId;
    private readonly Dictionary<int, string?> _selectedPlayerByGameId = new();
    private readonly Dictionary<int, string?> _selectedBetWinnerByGameId = new();
    private readonly Dictionary<int, int> _selectedBetAmountByGameId = new();
    private readonly Dictionary<int, string?> _betStatusByGameId = new();
    private readonly Dictionary<int, string?> _settleStatusByGameId = new();
    private readonly HashSet<int> _confirmWinnerPending = new();
    private readonly Dictionary<int, string?> _pendingWinnerSelectionByGameId = new();
    private readonly Dictionary<int, string?> _pendingTeamWinnerSelectionByGameId = new();
    private readonly HashSet<int> _teamModeGameIds = new();
    private readonly Dictionary<(int GameNightGameId, string TeamName), string?> _selectedTeamPlayerByKey = new();
    private IReadOnlyDictionary<int, BettingService.UserBet> _myBets = new Dictionary<int, BettingService.UserBet>();
    private readonly Dictionary<int, List<string>> _clientTeams = new();
    private readonly Dictionary<int, string?> _paletteImageUrlByGame = new();

    private readonly Dictionary<Guid, string?> _snackDraftByMemberId = new();
    private readonly Dictionary<Guid, string?> _snackStatusByMemberId = new();

    private readonly Dictionary<int, IReadOnlyList<VictoryRouteTemplate>> _victoryRoutesByGameId = new();
    private readonly Dictionary<int, Dictionary<Guid, string?>> _victoryRouteStringDraftByGameId = new();
    private readonly Dictionary<int, Dictionary<Guid, bool>> _victoryRouteBoolDraftByGameId = new();
    private readonly HashSet<int> _victoryRoutesOpen = new();
    private readonly Dictionary<int, string?> _victoryRouteStatusByGameId = new();

    private ElementReference _mondaysSectionRef;
    private string? _mondaysSectionBackgroundHex;
    private IReadOnlyList<WantToPlayService.WantToPlayEntry> _mostWanted = Array.Empty<WantToPlayService.WantToPlayEntry>();

    protected override async Task OnInitializedAsync()
    {
        var today = DateOnly.FromDateTime(DateTime.Today);
        var mondayOnOrBeforeToday = GetMondayOnOrBefore(today);
        _nextMonday = today.DayOfWeek == DayOfWeek.Monday
            ? mondayOnOrBeforeToday
            : mondayOnOrBeforeToday.AddDays(7);

        var auth = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = auth.User;
        var viewAsNonAdmin = string.Equals(
            HttpContextAccessor.HttpContext?.Request.Cookies["bgm_viewAsNonAdmin"],
            "1",
            StringComparison.Ordinal);
        _isAdmin = user.Identity?.IsAuthenticated == true && user.IsInRole("Admin") && !viewAsNonAdmin;
        _userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
        _memberId = TryGetMemberId(user);

        CoinService.Changed += OnCoinsChanged;
        WantToPlayService.Changed += OnWantToPlayChanged;
        await RefreshCoinsAsync();

        var dates = new HashSet<DateOnly>();

        if (_isAdmin)
        {
            var first = _nextMonday.AddDays(-7 * PastCountAdmin);
            for (var date = first; date < _nextMonday; date = date.AddDays(7))
            {
                dates.Add(date);
            }
        }
        else
        {
            // Non-admins can browse previous *actual* Board Game Mondays (only dates with a stored game night).
            foreach (var date in await GameNightService.GetRecentPastGameNightDatesAsync(_nextMonday, take: 12))
            {
                dates.Add(date);
            }
        }

        var lastUpcoming = _nextMonday.AddDays(7 * (UpcomingCount - 1));
        for (var date = _nextMonday; date <= lastUpcoming; date = date.AddDays(7))
        {
            dates.Add(date);
        }

        var pastDates = dates.Where(d => d < _nextMonday).ToList();
        _lastPastMonday = pastDates.Count == 0 ? null : pastDates.Max();

        foreach (var date in dates.OrderBy(d => d))
        {
            var kind = GetMondayKind(date);
            _items.Add(new MondayItem(date, kind));
        }

        // Populate game options (for planned games).
        // Keep this simple for now: all games.
        var games = await BoardGameService.GetAllAsync();
        _allGames.AddRange(games.Select(g => new GameOption(g.Id, g.Name)));

        // Member options for past-night attendance management.
        _allMembers.AddRange(await GameNightService.GetAllMembersAsync());

        _selected = _nextMonday;
        await LoadSelectedAsync();
        await RefreshMostWantedAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_selectedNight is null)
        {
            return;
        }

        if (firstRender)
        {
            try
            {
                _mondaysSectionBackgroundHex = await JS.InvokeAsync<string?>("bgm.getBackgroundHex", _mondaysSectionRef);
            }
            catch
            {
                _mondaysSectionBackgroundHex = null;
            }
        }

        foreach (var game in _selectedNight.Games)
        {
            var id = $"mondays-game-{game.Id}";

            // Resolve board game image via BoardGameService (GameNightGame contains only GameId)
            string? url = null;
            try
            {
                var bg = await BoardGameService.GetByIdAsync(game.GameId);
                url = bg?.ImageUrl;
            }
            catch
            {
                url = null;
            }

            _paletteImageUrlByGame.TryGetValue(game.Id, out var prev);
            if (string.Equals(prev, url, StringComparison.Ordinal))
            {
                continue;
            }

            try
            {
                if (string.IsNullOrWhiteSpace(url))
                {
                    if (!string.IsNullOrWhiteSpace(prev))
                    {
                        await JS.InvokeVoidAsync("bgm.clearPalette", id);
                        _paletteImageUrlByGame.Remove(game.Id);
                    }
                }
                else
                {
                    await JS.InvokeVoidAsync("bgm.applyPaletteFromImage", id, url);
                    _paletteImageUrlByGame[game.Id] = url;
                }
            }
            catch
            {
                // best-effort; ignore palette failures
            }
        }
    }

    public void Dispose()
    {
        CoinService.Changed -= OnCoinsChanged;
        WantToPlayService.Changed -= OnWantToPlayChanged;
    }

    private async Task RefreshMostWantedAsync()
    {
        _mostWanted = await WantToPlayService.GetTopWantedAsync(5);
    }

    private void OnWantToPlayChanged()
    {
        _ = InvokeAsync(async () =>
        {
            await RefreshMostWantedAsync();
            StateHasChanged();
        });
    }

    private void OnCoinsChanged()
    {
        _ = InvokeAsync(RefreshCoinsAsync);
    }

    private async Task SelectAsync(DateOnly date)
    {
        _selected = date;
        await LoadSelectedAsync();
    }

    private async Task LoadSelectedAsync()
    {
        _loading = true;
        _status = null;
        _selectedGameId = null;
        try
        {
            _selectedNight = await GameNightService.GetByDateAsync(_selected);
            _amAttending = _memberId is { } me && _selectedNight?.Attendees.Any(a => a.MemberId == me) == true;
            _declinedMemberIds = _selectedNight?.Rsvps.Where(r => !r.IsAttending).Select(r => r.MemberId).ToHashSet() ?? new();
            _recapEdit = _selectedNight?.Recap ?? string.Empty;
            _recapStatus = null;

            SyncSnackStateForSelectedNight(clearStatuses: true);

            if (_selectedNight is not null && !string.IsNullOrWhiteSpace(_userId))
            {
                _myBets = await BettingService.GetUserBetsForNightAsync(_selectedNight.Id, _userId);
            }
            else
            {
                _myBets = new Dictionary<int, BettingService.UserBet>();
            }
        }
        finally
        {
            _loading = false;
        }
    }

    private void SyncSnackStateForSelectedNight(bool clearStatuses)
    {
        _snackDraftByMemberId.Clear();

        if (clearStatuses)
        {
            _snackStatusByMemberId.Clear();
        }

        if (_selectedNight is null)
        {
            return;
        }

        var attendeeIds = _selectedNight.Attendees.Select(a => a.MemberId).ToHashSet();
        foreach (var k in _snackStatusByMemberId.Keys.Where(k => !attendeeIds.Contains(k)).ToArray())
        {
            _snackStatusByMemberId.Remove(k);
        }

        foreach (var a in _selectedNight.Attendees)
        {
            _snackDraftByMemberId[a.MemberId] = a.SnackBrought;
        }
    }

    private string? GetSnackDraft(Guid memberId)
        => _snackDraftByMemberId.TryGetValue(memberId, out var v) ? v : null;

    private void SetSnackDraft(Guid memberId, string? value)
        => _snackDraftByMemberId[memberId] = value;

    private async Task SaveSnackAsync(Guid memberId)
    {
        if (!_isAdmin || _selectedNight is null || _selected >= _nextMonday)
        {
            return;
        }

        _saving = true;
        _snackStatusByMemberId[memberId] = null;

        try
        {
            var snack = GetSnackDraft(memberId);
            _selectedNight = await GameNightService.SetSnackBroughtAsync(_selectedNight.Id, memberId, snack);
            SyncSnackStateForSelectedNight(clearStatuses: false);
            _snackStatusByMemberId[memberId] = "Saved";
        }
        catch
        {
            _snackStatusByMemberId[memberId] = "Failed";
        }
        finally
        {
            _saving = false;
        }
    }

    private async Task SaveRecapAsync()
    {
        if (!_isAdmin || _selectedNight is null)
        {
            return;
        }

        _savingRecap = true;
        _recapStatus = null;
        try
        {
            var updated = await GameNightService.SetRecapAsync(_selectedNight.Id, _recapEdit);
            _selectedNight = updated;
            _recapEdit = _selectedNight?.Recap ?? string.Empty;
            _recapStatus = "Saved";
        }
        finally
        {
            _savingRecap = false;
        }
    }

    private string GetMondayStateClass(DateOnly date)
    {
        if (date < _nextMonday)
        {
            if (_lastPastMonday is { } lastPast && date == lastPast)
            {
                return "is-last";
            }

            return "is-past";
        }

        if (date == _nextMonday)
        {
            return "is-next";
        }

        return "is-future";
    }

    private string GetMondayKind(DateOnly date)
    {
        if (_lastPastMonday is { } last && date == last)
        {
            return "Last Monday";
        }

        return date < _nextMonday ? "Past" : date == _nextMonday ? "Up next" : "Future";
    }

    private async Task RefreshCoinsAsync()
    {
        if (string.IsNullOrWhiteSpace(_userId))
        {
            _coins = null;
            return;
        }

        _coins = await CoinService.GetCoinsAsync(_userId);
        StateHasChanged();
    }

    private async Task CreateNightAsync()
    {
        if (!_isAdmin)
        {
            return;
        }

        _saving = true;
        _status = null;
        try
        {
            _selectedNight = await GameNightService.CreateAsync(_selected);
            _amAttending = _memberId is { } me && _selectedNight.Attendees.Any(a => a.MemberId == me);
            _declinedMemberIds = _selectedNight.Rsvps.Where(r => !r.IsAttending).Select(r => r.MemberId).ToHashSet();
        }
        finally
        {
            _saving = false;
        }
    }

    private async Task SetAttendingAsync(bool attending)
    {
        if (!_isAdmin || _selectedNight is null || _memberId is null)
        {
            return;
        }

        _saving = true;
        _status = null;
        try
        {
            var updated = await GameNightService.SetRsvpAsync(_selectedNight.Id, _memberId.Value, attending);
            _selectedNight = updated;
            _amAttending = attending;
            _declinedMemberIds = _selectedNight?.Rsvps.Where(r => !r.IsAttending).Select(r => r.MemberId).ToHashSet() ?? new();
        }
        finally
        {
            _saving = false;
        }
    }

    private async Task AddPlannedGameAsync()
    {
        if (!_isAdmin || _selectedNight is null)
        {
            return;
        }

        if (!Guid.TryParse(_selectedGameId, out var gameId))
        {
            return;
        }

        _saving = true;
        _status = null;
        try
        {
            // Don't set isPlayed here - it should only be set when winner result is confirmed
            _selectedNight = await GameNightService.AddGameAsync(_selectedNight.Id, gameId, isPlayed: false);
            _selectedGameId = null;
        }
        finally
        {
            _saving = false;
        }
    }

    private string GetSelectedPlayer(int gameNightGameId)
        => _selectedPlayerByGameId.TryGetValue(gameNightGameId, out var value) ? value ?? string.Empty : string.Empty;

    private void SetSelectedPlayer(int gameNightGameId, string? value)
    {
        _selectedPlayerByGameId[gameNightGameId] = value;
    }

    private async Task AddSelectedPlayerAsync(int gameNightGameId)
    {
        if (!_isAdmin || _selectedNight is null)
        {
            return;
        }

        if (!_selectedPlayerByGameId.TryGetValue(gameNightGameId, out var raw) || !Guid.TryParse(raw, out var memberId))
        {
            return;
        }

        _saving = true;
        _status = null;
        try
        {
            _selectedNight = await GameNightService.AddPlayerAsync(_selectedNight.Id, gameNightGameId, memberId);
            _selectedPlayerByGameId[gameNightGameId] = null;
        }
        finally
        {
            _saving = false;
        }
    }

    private async Task RemovePlayerAsync(int gameNightGameId, Guid memberId)
    {
        if (!_isAdmin || _selectedNight is null)
        {
            return;
        }

        _saving = true;
        _status = null;
        try
        {
            _selectedNight = await GameNightService.RemovePlayerAsync(_selectedNight.Id, gameNightGameId, memberId);
        }
        finally
        {
            _saving = false;
        }
    }

    private static bool HasTeams(GameNightService.GameNightGame game)
        => game.Players.Any(p => !string.IsNullOrWhiteSpace(p.TeamName));

    private bool IsTeamMode(GameNightService.GameNightGame game)
        => HasTeams(game) || _teamModeGameIds.Contains(game.Id);

    private static IReadOnlyList<string> GetTeams(GameNightService.GameNightGame game)
    {
        // Preserve the order teams first appear in the players list (stable insertion order),
        // but avoid duplicates using a case-insensitive comparison.
        var seen = new HashSet<string>(StringComparer.OrdinalIgnoreCase);
        var list = new List<string>();

        foreach (var name in game.Players
                     .Select(p => p.TeamName)
                     .Where(n => !string.IsNullOrWhiteSpace(n))
                     .Select(n => n!.Trim()))
        {
            if (seen.Add(name))
            {
                list.Add(name);
            }
        }

        return list;
    }

    private async Task SetPlayerTeamAsync(int gameNightGameId, Guid memberId, string? rawTeamName)
    {
        if (!_isAdmin || _selectedNight is null)
        {
            return;
        }

        _saving = true;
        _status = null;
        try
        {
            _selectedNight = await GameNightService.SetPlayerTeamAsync(_selectedNight.Id, gameNightGameId, memberId, rawTeamName);
        }
        finally
        {
            _saving = false;
        }
    }

    private async Task AddTeamWithSelectedPlayerAsync(int gameNightGameId)
    {
        if (!_isAdmin || _selectedNight is null)
        {
            return;
        }

        var nightId = _selectedNight.Id;

        if (!_selectedPlayerByGameId.TryGetValue(gameNightGameId, out var raw) || !Guid.TryParse(raw, out var memberId))
        {
            return;
        }

        var attendee = _selectedNight.Attendees.FirstOrDefault(a => a.MemberId == memberId);
        var baseName = attendee?.MemberName ?? string.Empty;
        var teamName = BuildAutoTeamName(baseName);

        _saving = true;
        _status = null;
        try
        {
            _selectedNight = await GameNightService.AddPlayerAsync(nightId, gameNightGameId, memberId) ?? _selectedNight;
            _selectedNight = await GameNightService.SetPlayerTeamAsync(nightId, gameNightGameId, memberId, teamName) ?? _selectedNight;
            _selectedPlayerByGameId[gameNightGameId] = null;
            _teamModeGameIds.Add(gameNightGameId);
        }
        finally
        {
            _saving = false;
        }
    }

    private async Task EnableTeamModeAsync(int gameNightGameId)
    {
        if (!_isAdmin || _selectedNight is null)
        {
            return;
        }

        var nightId = _selectedNight.Id;

        var game = _selectedNight.Games.FirstOrDefault(g => g.Id == gameNightGameId);
        if (game is null)
        {
            return;
        }

        if (game.IsConfirmed)
        {
            return;
        }

        _saving = true;
        _status = null;
        try
        {
            // Clear existing players so the admin can rebuild the lineup into teams.
            foreach (var player in game.Players.ToArray())
            {
                _selectedNight = await GameNightService.RemovePlayerAsync(nightId, gameNightGameId, player.MemberId) ?? _selectedNight;
            }

            _teamModeGameIds.Add(gameNightGameId);
        }
        finally
        {
            _saving = false;
        }
    }

    private static string BuildAutoTeamName(string memberName)
    {
        if (string.IsNullOrWhiteSpace(memberName))
        {
            return "Team";
        }

        var trimmed = new string(memberName.Where(char.IsLetterOrDigit).ToArray());
        if (trimmed.Length <= 3)
        {
            return $"Team {trimmed}";
        }

        return $"Team {trimmed.Substring(0, 3)}";
    }

    private string GetSelectedTeamPlayer(int gameNightGameId, string teamName)
        => _selectedTeamPlayerByKey.TryGetValue((gameNightGameId, teamName), out var value) ? value ?? string.Empty : string.Empty;

    private void SetSelectedTeamPlayer(int gameNightGameId, string teamName, string? value)
    {
        _selectedTeamPlayerByKey[(gameNightGameId, teamName)] = value;
    }

    private async Task AddSelectedPlayerToTeamAsync(int gameNightGameId, string teamName)
    {
        if (!_isAdmin || _selectedNight is null)
        {
            return;
        }

        var nightId = _selectedNight.Id;

        if (!_selectedTeamPlayerByKey.TryGetValue((gameNightGameId, teamName), out var raw) || !Guid.TryParse(raw, out var memberId))
        {
            return;
        }

        _saving = true;
        _status = null;
        try
        {
            _selectedNight = await GameNightService.AddPlayerAsync(nightId, gameNightGameId, memberId) ?? _selectedNight;
            _selectedNight = await GameNightService.SetPlayerTeamAsync(nightId, gameNightGameId, memberId, teamName) ?? _selectedNight;
            // Remove any client-only placeholder team with the same name to avoid duplicate display entries.
            if (_clientTeams.TryGetValue(gameNightGameId, out var ctList))
            {
                var removedCount = ctList.RemoveAll(n => string.Equals(n, teamName, StringComparison.OrdinalIgnoreCase));
                if (ctList.Count == 0)
                {
                    _clientTeams.Remove(gameNightGameId);
                }
                else if (removedCount > 0)
                {
                    _clientTeams[gameNightGameId] = ctList;
                }
            }
            _selectedTeamPlayerByKey[(gameNightGameId, teamName)] = null;
            _teamModeGameIds.Add(gameNightGameId);
        }
        finally
        {
            _saving = false;
        }
    }

    private void OnWinnerSelectionChanged(int gameNightGameId, string? value)
    {
        if (value == "NOT_SET")
        {
            _pendingWinnerSelectionByGameId.Remove(gameNightGameId);
        }
        else
        {
            _pendingWinnerSelectionByGameId[gameNightGameId] = value;
        }
    }

    private void CancelWinnerSelection(int gameNightGameId)
    {
        _pendingWinnerSelectionByGameId.Remove(gameNightGameId);
    }

    private void OnTeamWinnerSelectionChanged(int gameNightGameId, string? value)
    {
        if (value == "NOT_SET")
        {
            _pendingTeamWinnerSelectionByGameId.Remove(gameNightGameId);
        }
        else
        {
            _pendingTeamWinnerSelectionByGameId[gameNightGameId] = value;
        }
    }

    private void CancelTeamWinnerSelection(int gameNightGameId)
    {
        _pendingTeamWinnerSelectionByGameId.Remove(gameNightGameId);
    }

    private async Task ConfirmTeamWinnerSelectionAsync(int gameNightGameId)
    {
        if (!_isAdmin || _selectedNight is null)
        {
            return;
        }

        if (!_pendingTeamWinnerSelectionByGameId.TryGetValue(gameNightGameId, out var value))
        {
            return;
        }

        // Empty string means "No winner", which is a valid selection
        var teamName = string.IsNullOrEmpty(value) ? null : value;

        _saving = true;
        _status = null;
        try
        {
            // Set the team winner first
            _selectedNight = await GameNightService.SetTeamWinnerAsync(_selectedNight.Id, gameNightGameId, teamName);
            
            // Then resolve bets and update rankings
            if (_selectedNight is not null)
            {
                var result = await BettingService.ResolveGameAsync(_selectedNight.Id, gameNightGameId);
                _settleStatusByGameId[gameNightGameId] = result switch
                {
                    BettingService.ResolveResult.Ok => "Winner confirmed and settled.",
                    BettingService.ResolveResult.AlreadyResolved => "Winner confirmed (already settled).",
                    _ => null
                };
            }
            
            _confirmWinnerPending.Remove(gameNightGameId);
            _pendingTeamWinnerSelectionByGameId.Remove(gameNightGameId);

            var updatedGame = _selectedNight?.Games.FirstOrDefault(g => g.Id == gameNightGameId);
            if (updatedGame?.Winner is not null)
            {
                await OpenVictoryRoutesAsync(updatedGame);
            }
            
            // Refresh to reflect IsSettled status
            await LoadSelectedAsync();
        }
        finally
        {
            _saving = false;
        }
    }

    private async Task ConfirmWinnerSelectionAsync(int gameNightGameId)
    {
        if (!_isAdmin || _selectedNight is null)
        {
            return;
        }

        if (!_pendingWinnerSelectionByGameId.TryGetValue(gameNightGameId, out var value))
        {
            return;
        }

        Guid? winnerId = null;
        if (!string.IsNullOrEmpty(value) && Guid.TryParse(value, out var parsed))
        {
            winnerId = parsed;
        }

        _saving = true;
        _status = null;
        try
        {
            // Set the winner first
            _selectedNight = await GameNightService.SetWinnerAsync(_selectedNight.Id, gameNightGameId, winnerId);
            
            // Then resolve bets and update rankings
            if (_selectedNight is not null)
            {
                var result = await BettingService.ResolveGameAsync(_selectedNight.Id, gameNightGameId);
                _settleStatusByGameId[gameNightGameId] = result switch
                {
                    BettingService.ResolveResult.Ok => "Winner confirmed and settled.",
                    BettingService.ResolveResult.AlreadyResolved => "Winner confirmed (already settled).",
                    _ => null
                };
            }
            
            _confirmWinnerPending.Remove(gameNightGameId);
            _pendingWinnerSelectionByGameId.Remove(gameNightGameId);

            var updatedGame = _selectedNight?.Games.FirstOrDefault(g => g.Id == gameNightGameId);
            if (updatedGame?.Winner is not null)
            {
                await OpenVictoryRoutesAsync(updatedGame);
            }
            
            // Refresh to reflect IsSettled status
            await LoadSelectedAsync();
        }
        finally
        {
            _saving = false;
        }
    }

    private string? GetTeamColor(GameNightService.GameNightGame game, string teamName)
        => game.Teams?.FirstOrDefault(t => string.Equals(t.TeamName, teamName, StringComparison.OrdinalIgnoreCase))?.ColorHex;

    private async Task ChangeTeamColorAsync(int gameNightGameId, string teamName, string? color)
    {
        if (!_isAdmin || _selectedNight is null)
        {
            return;
        }

        _saving = true;
        _status = null;
        try
        {
            _selectedNight = await GameNightService.SetTeamColorAsync(_selectedNight.Id, gameNightGameId, teamName, color);
        }
        finally
        {
            _saving = false;
        }
    }

    private static string NormalizeColor(string? hex)
    {
        if (string.IsNullOrWhiteSpace(hex)) return "#ffffff";
        var h = hex.Trim();
        if (!h.StartsWith("#")) h = "#" + h;
        if (h.Length == 4)
        {
            // #rgb -> #rrggbb
            return "#" + string.Concat(h[1], h[1], h[2], h[2], h[3], h[3]);
        }
        if (h.Length >= 7) return h.Substring(0, 7);
        if (h.Length == 6) return "#" + h;
        return "#ffffff";
    }

    private static string GetContrastingText(string? hex)
    {
        if (string.IsNullOrWhiteSpace(hex)) return "#000";
        var h = hex.TrimStart('#');
        if (h.Length == 3) h = string.Concat(h[0], h[0], h[1], h[1], h[2], h[2]);
        if (h.Length < 6) return "#000";
        try
        {
            var r = int.Parse(h.Substring(0, 2), NumberStyles.HexNumber);
            var g = int.Parse(h.Substring(2, 2), NumberStyles.HexNumber);
            var b = int.Parse(h.Substring(4, 2), NumberStyles.HexNumber);
            var brightness = (299 * r + 587 * g + 114 * b) / 1000;
            return brightness > 128 ? "#000" : "#fff";
        }
        catch
        {
            return "#000";
        }
    }

    private bool ShouldRemoveTeamBorder(string? colorHex)
    {
        if (string.IsNullOrWhiteSpace(colorHex))
        {
            return false;
        }

        // If we can't determine the section background (e.g. JS interop failed), still remove the border
        // for custom colours; it generally looks better.
        if (string.IsNullOrWhiteSpace(_mondaysSectionBackgroundHex))
        {
            return true;
        }

        return !string.Equals(
            NormalizeColor(colorHex),
            NormalizeColor(_mondaysSectionBackgroundHex),
            StringComparison.OrdinalIgnoreCase);
    }

    private IReadOnlyList<VictoryRouteTemplate> GetVictoryRoutes(int gameNightGameId)
        => _victoryRoutesByGameId.TryGetValue(gameNightGameId, out var routes) ? routes : Array.Empty<VictoryRouteTemplate>();

    private async Task ToggleVictoryRoutesAsync(GameNightService.GameNightGame game)
    {
        if (_victoryRoutesOpen.Contains(game.Id))
        {
            _victoryRoutesOpen.Remove(game.Id);
            return;
        }

        await OpenVictoryRoutesAsync(game);
    }

    private async Task OpenVictoryRoutesAsync(GameNightService.GameNightGame game)
    {
        _victoryRoutesOpen.Add(game.Id);
        await EnsureVictoryRoutesLoadedAsync(game);
    }

    private async Task EnsureVictoryRoutesLoadedAsync(GameNightService.GameNightGame game)
    {
        if (_victoryRoutesByGameId.ContainsKey(game.Id))
        {
            return;
        }

        try
        {
            var routes = await GameNightService.GetVictoryRoutesForGameAsync(game.GameId);
            _victoryRoutesByGameId[game.Id] = routes;

            var existingValues = await GameNightService.GetVictoryRouteValuesAsync(game.Id);
            var byId = existingValues.ToDictionary(v => v.VictoryRouteId, v => v);

            var stringDraft = new Dictionary<Guid, string?>();
            var boolDraft = new Dictionary<Guid, bool>();

            foreach (var r in routes)
            {
                byId.TryGetValue(r.Id, out var v);

                if (r.Type == VictoryRouteType.Dropdown)
                {
                    stringDraft[r.Id] = v?.ValueString;
                }
                else if (r.Type == VictoryRouteType.Checkbox)
                {
                    boolDraft[r.Id] = v?.ValueBool ?? false;
                }
            }

            _victoryRouteStringDraftByGameId[game.Id] = stringDraft;
            _victoryRouteBoolDraftByGameId[game.Id] = boolDraft;
        }
        catch
        {
            _victoryRoutesByGameId[game.Id] = Array.Empty<VictoryRouteTemplate>();
        }
    }

    private string GetVictoryRouteString(int gameNightGameId, Guid routeId)
        => _victoryRouteStringDraftByGameId.TryGetValue(gameNightGameId, out var dict) && dict.TryGetValue(routeId, out var v) ? v ?? string.Empty : string.Empty;

    private void SetVictoryRouteString(int gameNightGameId, Guid routeId, string? value)
    {
        if (!_victoryRouteStringDraftByGameId.TryGetValue(gameNightGameId, out var dict))
        {
            dict = new Dictionary<Guid, string?>();
            _victoryRouteStringDraftByGameId[gameNightGameId] = dict;
        }

        dict[routeId] = value;
    }

    private bool GetVictoryRouteBool(int gameNightGameId, Guid routeId)
        => _victoryRouteBoolDraftByGameId.TryGetValue(gameNightGameId, out var dict) && dict.TryGetValue(routeId, out var v) && v;

    private void SetVictoryRouteBool(int gameNightGameId, Guid routeId, string? raw)
    {
        if (!_victoryRouteBoolDraftByGameId.TryGetValue(gameNightGameId, out var dict))
        {
            dict = new Dictionary<Guid, bool>();
            _victoryRouteBoolDraftByGameId[gameNightGameId] = dict;
        }

        dict[routeId] = string.Equals(raw, "true", StringComparison.OrdinalIgnoreCase) || string.Equals(raw, "on", StringComparison.OrdinalIgnoreCase);
    }

    private async Task SaveVictoryRoutesAsync(GameNightService.GameNightGame game)
    {
        if (!_isAdmin || _selectedNight is null)
        {
            return;
        }

        var routes = GetVictoryRoutes(game.Id);
        if (routes.Count == 0)
        {
            return;
        }

        _saving = true;
        _victoryRouteStatusByGameId[game.Id] = null;

        try
        {
            var values = new List<VictoryRouteValue>();
            foreach (var r in routes)
            {
                if (r.Type == VictoryRouteType.Dropdown)
                {
                    var v = GetVictoryRouteString(game.Id, r.Id);
                    values.Add(new VictoryRouteValue(r.Id, string.IsNullOrWhiteSpace(v) ? null : v, null));
                }
                else if (r.Type == VictoryRouteType.Checkbox)
                {
                    values.Add(new VictoryRouteValue(r.Id, null, GetVictoryRouteBool(game.Id, r.Id)));
                }
            }

            var ok = await GameNightService.UpsertVictoryRouteValuesAsync(_selectedNight.Id, game.Id, values);
            _victoryRouteStatusByGameId[game.Id] = ok ? "Saved" : "Failed";
        }
        catch
        {
            _victoryRouteStatusByGameId[game.Id] = "Failed";
        }
        finally
        {
            _saving = false;
        }
    }

    private void BeginConfirmWinner(int gameNightGameId)
    {
        _confirmWinnerPending.Add(gameNightGameId);
        _settleStatusByGameId[gameNightGameId] = "This will pay out coins and lock the winner.";
    }

    private void CancelConfirmWinner(int gameNightGameId)
    {
        _confirmWinnerPending.Remove(gameNightGameId);
        _settleStatusByGameId[gameNightGameId] = null;
    }

    private async Task ConfirmWinnerAsync(int gameNightGameId)
    {
        if (!_isAdmin || _selectedNight is null)
        {
            return;
        }

        _saving = true;
        _settleStatusByGameId[gameNightGameId] = null;
        try
        {
            var result = await BettingService.ResolveGameAsync(_selectedNight.Id, gameNightGameId);
            _settleStatusByGameId[gameNightGameId] = result switch
            {
                BettingService.ResolveResult.Ok => "Winnings resolved.",
                BettingService.ResolveResult.AlreadyResolved => "Already settled.",
                BettingService.ResolveResult.MissingWinner => "Select a winner first.",
                BettingService.ResolveResult.NotPast => "Can only settle past games.",
                _ => "Couldn't settle."
            };

            _confirmWinnerPending.Remove(gameNightGameId);

            // Refresh to reflect IsSettled.
            await LoadSelectedAsync();
        }
        finally
        {
            _saving = false;
        }
    }

    private async Task AddSelectedMemberAsync()
    {
        if (!_isAdmin || _selectedNight is null)
        {
            return;
        }

        if (!Guid.TryParse(_selectedMemberId, out var memberId))
        {
            return;
        }

        await SetMemberAttendanceAsync(memberId, true);
        _selectedMemberId = null;
    }

    private async Task SetMemberAttendanceAsync(Guid memberId, bool attending)
    {
        if (!_isAdmin || _selectedNight is null)
        {
            return;
        }

        _saving = true;
        _status = null;
        try
        {
            _selectedNight = await GameNightService.SetAttendanceAsync(_selectedNight.Id, memberId, attending, respectExplicitDeclines: attending);
            _amAttending = _memberId is { } me && _selectedNight?.Attendees.Any(a => a.MemberId == me) == true;
            _declinedMemberIds = _selectedNight?.Rsvps.Where(r => !r.IsAttending).Select(r => r.MemberId).ToHashSet() ?? new();
            SyncSnackStateForSelectedNight(clearStatuses: false);
        }
        finally
        {
            _saving = false;
        }
    }

    private string GetRsvpLink(DateOnly date)
    {
        var relative = $"rsvp?date={date:yyyy-MM-dd}";
        return new Uri(new Uri(Navigation.BaseUri), relative).ToString();
    }

    private async Task CopyRsvpLinkAsync()
    {
        var link = GetRsvpLink(_selected);
        var copied = await JS.InvokeAsync<bool>("bgm.copyText", link);
        _shareStatus = copied ? "Link copied." : "Couldn't copy the link.";
    }

    private async Task RemoveGameAsync(int gameNightGameId)
    {
        if (!_isAdmin || _selectedNight is null)
        {
            return;
        }

        var name = _selectedNight.Games.FirstOrDefault(g => g.Id == gameNightGameId)?.GameName ?? "this game";

        bool ok;
        try
        {
            ok = await JS.InvokeAsync<bool>("confirm",
                $"Remove '{name}' from this Monday? This will delete its teams/players/odds/bets.");
        }
        catch
        {
            // If confirm isn't available for some reason, fail safe (don't remove).
            return;
        }

        if (!ok)
        {
            return;
        }

        _saving = true;
        _status = null;
        try
        {
            CleanupRemovedGameClientState(gameNightGameId);
            _selectedNight = await GameNightService.RemoveGameAsync(_selectedNight.Id, gameNightGameId);
        }
        finally
        {
            _saving = false;
        }
    }

    private void CleanupRemovedGameClientState(int gameNightGameId)
    {
        _selectedPlayerByGameId.Remove(gameNightGameId);
        _selectedBetWinnerByGameId.Remove(gameNightGameId);
        _selectedBetAmountByGameId.Remove(gameNightGameId);
        _betStatusByGameId.Remove(gameNightGameId);
        _settleStatusByGameId.Remove(gameNightGameId);
        _confirmWinnerPending.Remove(gameNightGameId);
        _teamModeGameIds.Remove(gameNightGameId);
        _clientTeams.Remove(gameNightGameId);
        _paletteImageUrlByGame.Remove(gameNightGameId);

        foreach (var key in _selectedTeamPlayerByKey.Keys.Where(k => k.GameNightGameId == gameNightGameId).ToArray())
        {
            _selectedTeamPlayerByKey.Remove(key);
        }
    }

    private async Task ConfirmGameAsync(int gameNightGameId)
    {
        if (!_isAdmin || _selectedNight is null)
        {
            return;
        }

        var name = _selectedNight.Games.FirstOrDefault(g => g.Id == gameNightGameId)?.GameName ?? "this game";

        bool ok;
        try
        {
            ok = await JS.InvokeAsync<bool>("confirm",
                $"Confirm '{name}'? Confirming a game cannot be undone, is this definitely being played and are the people or teams correct?");
        }
        catch
        {
            // If confirm isn't available for some reason, fail safe (don't confirm).
            return;
        }

        if (!ok)
        {
            return;
        }

        _saving = true;
        _status = null;
        try
        {
            _selectedNight = await GameNightService.ConfirmGameAsync(_selectedNight.Id, gameNightGameId);
        }
        finally
        {
            _saving = false;
        }
    }

    private static (int Numerator, int Denominator)? ToFraction(int? oddsTimes100)
    {
        if (oddsTimes100 is null || oddsTimes100 <= 100)
        {
            return null;
        }

        var numerator = oddsTimes100.Value - 100;
        var denominator = 100;
        var gcd = Gcd(numerator, denominator);
        return (numerator / gcd, denominator / gcd);
    }

    private static int Gcd(int a, int b)
    {
        a = Math.Abs(a);
        b = Math.Abs(b);
        while (b != 0)
        {
            var t = a % b;
            a = b;
            b = t;
        }
        return a == 0 ? 1 : a;
    }

    private static string FormatFraction(int? oddsTimes100)
    {
        var f = ToFraction(oddsTimes100);
        return f is null ? "â€”" : $"{f.Value.Numerator}/{f.Value.Denominator}";
    }

    private static int? ComputeProfit(int amount, int oddsTimes100)
    {
        var f = ToFraction(oddsTimes100);
        if (f is null)
        {
            return null;
        }

        return (amount * f.Value.Numerator) / f.Value.Denominator;
    }

    private int GetSelectedAmount(int gameNightGameId)
        => _selectedBetAmountByGameId.TryGetValue(gameNightGameId, out var value) ? value : 10;

    private int? GetSelectedProfit(GameNightService.GameNightGame game)
    {
        if (!_selectedBetWinnerByGameId.TryGetValue(game.Id, out var rawWinner) || !Guid.TryParse(rawWinner, out var winnerId))
        {
            return null;
        }

        var odds = game.Odds.FirstOrDefault(o => o.MemberId == winnerId)?.OddsTimes100;
        if (odds is null)
        {
            return null;
        }

        var amount = GetSelectedAmount(game.Id);
        return ComputeProfit(amount, odds.Value);
    }

    private string GetSelectedBetWinner(int gameNightGameId)
        => _selectedBetWinnerByGameId.TryGetValue(gameNightGameId, out var value) ? value ?? string.Empty : string.Empty;

    private void SetSelectedBetWinner(int gameNightGameId, string? value)
    {
        _selectedBetWinnerByGameId[gameNightGameId] = value;
        _betStatusByGameId[gameNightGameId] = null;
    }

    private string GetSelectedBetAmount(int gameNightGameId)
        => _selectedBetAmountByGameId.TryGetValue(gameNightGameId, out var value) ? value.ToString(CultureInfo.InvariantCulture) : "10";

    private void SetSelectedBetAmount(int gameNightGameId, string? raw)
    {
        if (int.TryParse(raw, NumberStyles.Integer, CultureInfo.InvariantCulture, out var amount))
        {
            _selectedBetAmountByGameId[gameNightGameId] = Math.Max(1, amount);
        }
        _betStatusByGameId[gameNightGameId] = null;
    }

    private async Task PlaceBetAsync(int gameNightGameId)
    {
        if (_selectedNight is null || string.IsNullOrWhiteSpace(_userId))
        {
            return;
        }

        if (!_selectedBetWinnerByGameId.TryGetValue(gameNightGameId, out var rawWinner) || !Guid.TryParse(rawWinner, out var winnerId))
        {
            _betStatusByGameId[gameNightGameId] = "Pick a winner.";
            return;
        }

        if (!_selectedBetAmountByGameId.TryGetValue(gameNightGameId, out var amount))
        {
            amount = 10;
        }

        _saving = true;
        _betStatusByGameId[gameNightGameId] = null;
        try
        {
            var result = await BettingService.PlaceBetAsync(_selectedNight.Id, gameNightGameId, winnerId, amount, _userId);
            _betStatusByGameId[gameNightGameId] = result switch
            {
                BettingService.PlaceBetResult.Ok => "Bet placed.",
                BettingService.PlaceBetResult.NotEnoughCoins => "Not enough coins.",
                BettingService.PlaceBetResult.MissingOdds => "Odds not set yet.",
                BettingService.PlaceBetResult.NotConfirmed => "Not confirmed yet.",
                BettingService.PlaceBetResult.AlreadyBet => "You already bet on this game.",
                _ => "Couldn't place bet."
            };

            _myBets = await BettingService.GetUserBetsForNightAsync(_selectedNight.Id, _userId);
            await RefreshCoinsAsync();
        }
        finally
        {
            _saving = false;
        }
    }

    private static Guid? TryGetMemberId(ClaimsPrincipal user)
    {
        var value = user.FindFirst("bgm:memberId")?.Value;
        return Guid.TryParse(value, out var id) ? id : null;
    }

    private static DateOnly GetMondayOnOrBefore(DateOnly date)
    {
        // DayOfWeek: Sunday=0 ... Saturday=6
        var delta = (7 + ((int)date.DayOfWeek - (int)DayOfWeek.Monday)) % 7;
        return date.AddDays(-delta);
    }

    private static string FormatLongDate(DateOnly date)
        => date.ToDateTime(TimeOnly.MinValue).ToString("dddd d MMMM yyyy");

    private sealed record MondayItem(DateOnly Date, string Kind);

    private sealed record GameOption(Guid Id, string Name);

    private async Task AddEmptyTeamAsync(int gameNightGameId)
    {
        if (!_isAdmin || _selectedNight is null)
        {
            return;
        }

        var game = _selectedNight.Games.FirstOrDefault(g => g.Id == gameNightGameId);
        if (game is null)
        {
            return;
        }
        // If an attendee is selected for this game, create the team with that attendee.
        var selected = GetSelectedPlayer(gameNightGameId);
        if (!string.IsNullOrWhiteSpace(selected) && Guid.TryParse(selected, out _))
        {
            await AddTeamWithSelectedPlayerAsync(gameNightGameId);
            return;
        }

        // Ensure the generated team name does not duplicate any existing server or client-side team (case-insensitive).
        _clientTeams.TryGetValue(gameNightGameId, out var list);
        list ??= new List<string>();

        var existingNames = new HashSet<string>(GetTeams(game), StringComparer.OrdinalIgnoreCase);
        foreach (var n in list)
        {
            existingNames.Add(n);
        }

        // Choose the lowest Team N that isn't already used (Team 1, Team 2, ...)
        var i = 1;
        string teamName;
        do
        {
            teamName = $"Team {i}";
            i++;
        } while (existingNames.Contains(teamName));

        list.Add(teamName);
        _clientTeams[gameNightGameId] = list;

        // Rerender â€” actual persistence happens when an attendee is added to this team
        StateHasChanged();
    }

    private void RenameClientTeam(int gameNightGameId, string oldName, string? newName)
    {
        if (string.IsNullOrWhiteSpace(newName) || string.Equals(newName, oldName, StringComparison.OrdinalIgnoreCase))
        {
            return;
        }

        if (!_clientTeams.TryGetValue(gameNightGameId, out var list))
        {
            return;
        }

        // prevent duplicates (case-insensitive). Allow keeping same name casing for the same team.
        var serverTeams = GetTeams(_selectedNight!.Games.First(g => g.Id == gameNightGameId));
        var conflictWithClient = list.Any(n => !string.Equals(n, oldName, StringComparison.OrdinalIgnoreCase) && string.Equals(n, newName, StringComparison.OrdinalIgnoreCase));
        var conflictWithServer = serverTeams.Any(n => string.Equals(n, newName, StringComparison.OrdinalIgnoreCase));
        if (conflictWithClient || conflictWithServer)
        {
            return;
        }

        var idx = list.IndexOf(oldName);
        if (idx < 0)
        {
            return;
        }

        list[idx] = newName;

        // move any selected-team-player entries keyed by oldName to newName
        var keyOld = (gameNightGameId, oldName);
        var keyNew = (gameNightGameId, newName);
        if (_selectedTeamPlayerByKey.TryGetValue(keyOld, out var val))
        {
            _selectedTeamPlayerByKey[keyNew] = val;
            _selectedTeamPlayerByKey.Remove(keyOld);
        }

        _clientTeams[gameNightGameId] = list;
        StateHasChanged();
    }
}
