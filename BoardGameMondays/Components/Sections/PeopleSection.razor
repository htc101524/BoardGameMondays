@using BoardGameMondays.Core
@using BoardGameMondays.Data
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.WebUtilities
@using Microsoft.EntityFrameworkCore
@inject NavigationManager Navigation
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject AuthenticationStateProvider AuthStateProvider
@inject IHttpContextAccessor HttpContextAccessor
@inject IConfiguration Configuration

<section id="people" class="home-section" aria-label="People">
    @* PageTitle is normally provided by the hosting shell; omit here to avoid component resolution issues. *@

    <div class="home-section__inner">
        <h1>People</h1>

        @if (_isAdmin)
        {
            <form class="mb-3" method="post" action="/account/avatar" enctype="multipart/form-data">
                <AntiforgeryToken />
                <label class="form-label" for="avatar-file">Your avatar</label>
                <div class="d-flex gap-2 align-items-center flex-wrap">
                    <input id="avatar-file" class="form-control" style="max-width: 420px" type="file" name="avatar" accept="image/*" required />
                    <button type="submit" class="btn btn-outline-primary">Upload</button>
                </div>
                <div class="form-text">Supported formats: JPG, PNG, WEBP, GIF. Max size: 10MB.</div>
                @if (!string.IsNullOrWhiteSpace(_avatarMessage))
                {
                    <div class="alert mt-2 @_avatarMessageCss" role="alert">@_avatarMessage</div>
                }
            </form>
        }

        <div class="text-muted small mb-2">Click on a BGM Member to view their stats</div>

        <div class="bgm-peopleGrid" role="list" aria-label="Members">
            @foreach (var member in _members)
            {
                <a class="bgm-peopleCard bgm-peopleCard--link" role="listitem" aria-label="@member.Name" href="/people/@member.Id">
                    <div class="bgm-peopleCard__top">
                        <div class="bgm-peopleCard__avatar" aria-hidden="true">
                            @if (!string.IsNullOrWhiteSpace(member.AvatarUrl))
                            {
                                <img src="@member.AvatarUrl" alt="" />
                            }
                            else
                            {
                                @(string.IsNullOrWhiteSpace(member.Name) ? "?" : member.Name[..1].ToUpperInvariant())
                            }
                        </div>
                        <div class="bgm-peopleCard__who">
                            <div class="bgm-peopleCard__name">@member.Name</div>
                            @if (!string.IsNullOrWhiteSpace(member.Tagline))
                            {
                                <div class="bgm-peopleCard__tagline">@member.Tagline</div>
                            }
                        </div>
                    </div>

                    @if (!string.IsNullOrWhiteSpace(member.FunFact))
                    {
                        <p class="bgm-peopleCard__summary"><strong>Fun fact:</strong> @member.FunFact</p>
                    }
                </a>
            }
        </div>
    </div>
</section>

@code {
    private string? _avatarMessage;
    private string _avatarMessageCss = "alert-info";
    private IReadOnlyList<MemberCard> _members = Array.Empty<MemberCard>();
    private bool _isAdmin;

    protected override async Task OnInitializedAsync()
    {
        var auth = await AuthStateProvider.GetAuthenticationStateAsync();
        var viewAsNonAdmin = string.Equals(
            HttpContextAccessor.HttpContext?.Request.Cookies["bgm_viewAsNonAdmin"],
            "1",
            StringComparison.Ordinal);
        _isAdmin = auth.User.Identity?.IsAuthenticated == true && auth.User.IsInRole("Admin") && !viewAsNonAdmin;

        await using var db = await DbFactory.CreateDbContextAsync();
        
        // Get admin user IDs to ensure only actual admins show up in People
        var adminUserIds = await GetAdminUserIdsAsync(db);
        
        // Get admin member IDs from user claims
        var adminMemberIdClaims = await db.UserClaims
            .AsNoTracking()
            .Where(c => adminUserIds.Contains(c.UserId) && c.ClaimType == "bgm:memberId")
            .Select(c => c.ClaimValue)
            .Where(v => !string.IsNullOrWhiteSpace(v))
            .ToListAsync();
        
        var adminMemberIds = adminMemberIdClaims
            .Select(v => Guid.TryParse(v, out var id) ? id : (Guid?)null)
            .Where(id => id.HasValue)
            .Select(id => id!.Value)
            .ToHashSet();
        
        _members = await db.Members
            .AsNoTracking()
            .Where(m => m.IsBgmMember && adminMemberIds.Contains(m.Id))
            .OrderBy(m => m.Name)
            .Select(m => new MemberCard(m.Id, m.Name, m.ProfileTagline, m.FunFact, m.AvatarUrl))
            .ToListAsync();
    }
    
    private async Task<HashSet<string>> GetAdminUserIdsAsync(ApplicationDbContext db)
    {
        // Admins are defined via configuration (see AdminRoleClaimsTransformation)
        var configuredUserNames = Configuration.GetSection("Security:Admins:UserNames").Get<string[]>() ?? [];
        var normalizedConfigured = configuredUserNames
            .Select(x => x?.Trim())
            .Where(x => !string.IsNullOrWhiteSpace(x))
            .Select(x => x!.ToUpperInvariant())
            .Distinct(StringComparer.Ordinal)
            .ToList();

        HashSet<string> adminUserIds;
        if (normalizedConfigured.Count > 0)
        {
            var ids = await db.Users
                .AsNoTracking()
                .Where(u => u.NormalizedUserName != null && normalizedConfigured.Contains(u.NormalizedUserName))
                .Select(u => u.Id)
                .ToListAsync();
            adminUserIds = ids.ToHashSet(StringComparer.Ordinal);
        }
        else
        {
            var adminRoleId = await db.Roles
                .AsNoTracking()
                .Where(r => r.Name == "Admin")
                .Select(r => r.Id)
                .FirstOrDefaultAsync();

            if (string.IsNullOrWhiteSpace(adminRoleId))
            {
                adminUserIds = new HashSet<string>(StringComparer.Ordinal);
            }
            else
            {
                var ids = await db.UserRoles
                    .AsNoTracking()
                    .Where(ur => ur.RoleId == adminRoleId)
                    .Select(ur => ur.UserId)
                    .Distinct()
                    .ToListAsync();
                adminUserIds = ids.ToHashSet(StringComparer.Ordinal);
            }
        }

        return adminUserIds;
    }

    protected override void OnParametersSet()
    {
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        var query = QueryHelpers.ParseQuery(uri.Query);

        if (query.TryGetValue("avatarError", out var error) && !string.IsNullOrWhiteSpace(error))
        {
            _avatarMessage = error.ToString();
            _avatarMessageCss = "alert-danger";
        }
        else if (query.TryGetValue("avatarUpdated", out var updated) && updated == "1")
        {
            _avatarMessage = "Avatar updated.";
            _avatarMessageCss = "alert-success";
        }
        else
        {
            _avatarMessage = null;
            _avatarMessageCss = "alert-info";
        }
    }

    private sealed record MemberCard(Guid Id, string Name, string? Tagline, string? FunFact, string? AvatarUrl);
}
