@using BoardGameMondays.Core
@using BoardGameMondays.Data
@using Microsoft.EntityFrameworkCore
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject IConfiguration Configuration
@inject ShopService ShopService

<section id="people" class="home-section" aria-label="People">
    @* PageTitle is normally provided by the hosting shell; omit here to avoid component resolution issues. *@

    <div class="home-section__inner">
        <h1>People</h1>

        <div class="text-muted small mb-2">Click on a BGM Member to view their stats</div>

        <div class="bgm-peopleGrid" role="list" aria-label="Members">
            @foreach (var member in _members)
            {
                <a class="bgm-peopleCard bgm-peopleCard--link" role="listitem" aria-label="@member.Name" href="/people/@member.Id">
                    <div class="bgm-peopleCard__top">
                        @{
                            var badgeRing = _badgeRings.GetValueOrDefault(member.Id);
                            var ringClass = !string.IsNullOrWhiteSpace(badgeRing) ? $"bgm-badgeRing bgm-badgeRing--{badgeRing}" : "";
                        }
                        <div class="@ringClass">
                            <div class="bgm-peopleCard__avatar" aria-hidden="true">
                                @if (!string.IsNullOrWhiteSpace(member.AvatarUrl))
                                {
                                    <img src="@member.AvatarUrl" alt="" />
                                }
                                else
                                {
                                    @(string.IsNullOrWhiteSpace(member.Name) ? "?" : member.Name[..1].ToUpperInvariant())
                                }
                            </div>
                        </div>
                        <div class="bgm-peopleCard__who">
                            <div class="bgm-peopleCard__name">@member.Name</div>
                            @if (!string.IsNullOrWhiteSpace(member.Tagline))
                            {
                                <div class="bgm-peopleCard__tagline">@member.Tagline</div>
                            }
                        </div>
                    </div>

                    @if (!string.IsNullOrWhiteSpace(member.FunFact))
                    {
                        <p class="bgm-peopleCard__summary"><strong>Fun fact:</strong> @member.FunFact</p>
                    }
                </a>
            }
        </div>
    </div>
</section>

@code {
    private IReadOnlyList<MemberCard> _members = Array.Empty<MemberCard>();
    private Dictionary<Guid, string> _badgeRings = new();

    protected override async Task OnInitializedAsync()
    {
        await using var db = await DbFactory.CreateDbContextAsync();
        
        // Get admin user IDs to ensure only actual admins show up in People
        var adminUserIds = await GetAdminUserIdsAsync(db);
        
        // Get admin member IDs from user claims
        var adminMemberIdClaims = await db.UserClaims
            .AsNoTracking()
            .Where(c => adminUserIds.Contains(c.UserId) && c.ClaimType == "bgm:memberId")
            .Select(c => c.ClaimValue)
            .Where(v => !string.IsNullOrWhiteSpace(v))
            .ToListAsync();
        
        var adminMemberIds = adminMemberIdClaims
            .Select(v => Guid.TryParse(v, out var id) ? id : (Guid?)null)
            .Where(id => id.HasValue)
            .Select(id => id!.Value)
            .ToHashSet();
        
        _members = await db.Members
            .AsNoTracking()
            .Where(m => m.IsBgmMember && adminMemberIds.Contains(m.Id))
            .OrderBy(m => m.Name)
            .Select(m => new MemberCard(m.Id, m.Name, m.ProfileTagline, m.FunFact, m.AvatarUrl))
            .ToListAsync();
        
        // Load badge rings for all members
        var memberUserIds = await db.UserClaims
            .AsNoTracking()
            .Where(c => c.ClaimType == "bgm:memberId" && _members.Select(m => m.Id.ToString()).Contains(c.ClaimValue))
            .Select(c => c.UserId)
            .ToListAsync();
        
        foreach (var userId in memberUserIds)
        {
            var badgeRing = await ShopService.GetUserBadgeRingAsync(userId);
            if (!string.IsNullOrWhiteSpace(badgeRing))
            {
                var memberIdClaim = await db.UserClaims
                    .Where(c => c.UserId == userId && c.ClaimType == "bgm:memberId")
                    .Select(c => c.ClaimValue)
                    .FirstOrDefaultAsync();
                
                if (memberIdClaim is not null && Guid.TryParse(memberIdClaim, out var memberId))
                {
                    _badgeRings[memberId] = badgeRing;
                }
            }
        }
    }
    
    private async Task<HashSet<string>> GetAdminUserIdsAsync(ApplicationDbContext db)
    {
        // Admins are defined via configuration (see AdminRoleClaimsTransformation)
        var configuredUserNames = Configuration.GetSection("Security:Admins:UserNames").Get<string[]>() ?? [];
        var normalizedConfigured = configuredUserNames
            .Select(x => x?.Trim())
            .Where(x => !string.IsNullOrWhiteSpace(x))
            .Select(x => x!.ToUpperInvariant())
            .Distinct(StringComparer.Ordinal)
            .ToList();

        HashSet<string> adminUserIds;
        if (normalizedConfigured.Count > 0)
        {
            var ids = await db.Users
                .AsNoTracking()
                .Where(u => u.NormalizedUserName != null && normalizedConfigured.Contains(u.NormalizedUserName))
                .Select(u => u.Id)
                .ToListAsync();
            adminUserIds = ids.ToHashSet(StringComparer.Ordinal);
        }
        else
        {
            var adminRoleId = await db.Roles
                .AsNoTracking()
                .Where(r => r.Name == "Admin")
                .Select(r => r.Id)
                .FirstOrDefaultAsync();

            if (string.IsNullOrWhiteSpace(adminRoleId))
            {
                adminUserIds = new HashSet<string>(StringComparer.Ordinal);
            }
            else
            {
                var ids = await db.UserRoles
                    .AsNoTracking()
                    .Where(ur => ur.RoleId == adminRoleId)
                    .Select(ur => ur.UserId)
                    .Distinct()
                    .ToListAsync();
                adminUserIds = ids.ToHashSet(StringComparer.Ordinal);
            }
        }

        return adminUserIds;
    }

    private sealed record MemberCard(Guid Id, string Name, string? Tagline, string? FunFact, string? AvatarUrl);
}
