@using Microsoft.AspNetCore.Components.Web
@implements IDisposable
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@inject IHttpContextAccessor HttpContextAccessor

<section id="games" class="home-section" aria-label="Games">

    <div class="home-section__inner">
        <div class="bgm-gamesHeader">
            <div class="bgm-segmented" role="tablist" aria-label="Games view" style="--bgm-seg-index: @((int)_mode)">
                <button type="button"
                        class="bgm-segmented__item @(_mode == GamesMode.Decided ? "is-active" : "")"
                        role="tab"
                        aria-selected="@(_mode == GamesMode.Decided)"
                        @onclick="() => SetModeAsync(GamesMode.Decided)">
                    Decided
                </button>
                <button type="button"
                        class="bgm-segmented__item @(_mode == GamesMode.Playing ? "is-active" : "")"
                        role="tab"
                        aria-selected="@(_mode == GamesMode.Playing)"
                        @onclick="() => SetModeAsync(GamesMode.Playing)">
                    Playing
                </button>
                <button type="button"
                        class="bgm-segmented__item @(_mode == GamesMode.Queued ? "is-active" : "")"
                        role="tab"
                        aria-selected="@(_mode == GamesMode.Queued)"
                        @onclick="() => SetModeAsync(GamesMode.Queued)">
                    Queued
                </button>
            </div>

            <div class="bgm-gamesSearch">
                <input class="bgm-gamesSearch__input"
                       placeholder="Search game"
                       value="@_searchText"
                       @oninput="OnSearchInput"
                       @onfocus="() => _searchOpen = true"
                       @onblur="OnSearchBlur"
                       aria-label="Search games" />

                @if (_isAdmin)
                {
                    <div class="bgm-gamesSearch__meta">Votes left: @_votesRemaining / @_votesLimit</div>
                }

                @if (_searchOpen && !string.IsNullOrWhiteSpace(_searchText))
                {
                    <div class="bgm-gamesSearch__results" role="listbox" aria-label="Game search results">
                        @if (_searchMatches.Count == 0)
                        {
                            <div class="bgm-gamesSearch__empty">No games match that name</div>
                        }
                        else
                        {
                            @foreach (var match in _searchMatches)
                            {
                                <button type="button"
                                        class="bgm-gamesSearch__item"
                                        role="option"
                                        @onmousedown="() => SelectSearchMatchAsync(match)">
                                    <span class="bgm-gamesSearch__name">@match.Name</span>
                                    <span class="bgm-gamesSearch__status">@FormatStatus(match.Status)</span>
                                </button>
                            }
                        }
                    </div>
                }
            </div>
        </div>

        <h1>Games</h1>
        <p class="text-muted mb-3">Tip: click a game to see the BGM reviews.</p>

        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
            @foreach (var game in _games)
            {
                <div class="col">
                    <div class="bgm-gameCardButton" role="button" tabindex="0" aria-label="@("Show thoughts for " + game.Name)"
                        @onclick="() => SelectGameAsync(game)">
                        <div class="card h-100">
                            <img class="card-img-top" src='@(game.ImageUrl ?? "images/placeholder-game-cover.svg")' alt="" />
                            <div class="card-body">
                                <h5 class="card-title">@game.Name</h5>
                                @if (!string.IsNullOrWhiteSpace(game.Tagline))
                                {
                                    <p class="card-text">@game.Tagline</p>
                                }
                            </div>
                            <div class="card-footer d-flex justify-content-between align-items-center">
                                <small class="text-muted">
                                    @if (game.ReviewedOn is { } reviewedOn)
                                    {
                                        <span>Latest review @FormatReviewedOn(reviewedOn)</span>
                                    }
                                    else
                                    {
                                        <span>Not reviewed yet</span>
                                    }
                                </small>

                                <div class="d-flex align-items-center" style="gap:10px">
                                    <small class="text-muted">@game.Reviews.Count review(s)</small>

                                    @if (_isAdmin)
                                    {
                                        <div class="bgm-gameCardActions">
                                            <a href="/admin/games/@game.Id" class="btn btn-sm btn-outline-primary" title="Edit game">
                                                Edit
                                            </a>
                                            <button type="button"
                                                    class="btn btn-sm @(HasVoted(game.Id) ? "btn-success" : "btn-outline-secondary")"
                                                    disabled="@(HasVoted(game.Id) || _votesRemaining <= 0)"
                                                    @onclick="@(async () => await VoteWantToPlayAsync(game.Id))">
                                                @(HasVoted(game.Id) ? "Voted" : "Want to play")
                                            </button>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>

        @if (_pageCount > 1)
        {
            <div class="bgm-gamesPager" role="navigation" aria-label="Games pages">
                <button type="button"
                        class="bgm-gamesPager__btn"
                        disabled="@(_pageIndex == 0)"
                        @onclick="() => ChangePageAsync(_pageIndex - 1)">
                    Prev
                </button>

                <div class="bgm-gamesPager__pages">
                    @foreach (var page in GetPageNumbers())
                    {
                        <button type="button"
                                class="bgm-gamesPager__page @(_pageIndex == page ? "is-active" : "")"
                                @onclick="() => ChangePageAsync(page)">
                            @(page + 1)
                        </button>
                    }
                </div>

                <button type="button"
                        class="bgm-gamesPager__btn"
                        disabled="@(_pageIndex >= _pageCount - 1)"
                        @onclick="() => ChangePageAsync(_pageIndex + 1)">
                    Next
                </button>
            </div>
        }
    </div>
</section>

@inject BoardGameMondays.Core.BoardGameService BoardGameService
@inject BoardGameMondays.Core.WantToPlayService WantToPlayService
@inject AuthenticationStateProvider AuthStateProvider

@code {
    [Parameter]
    public EventCallback<BoardGameMondays.Core.BoardGame> OnGameSelected { get; set; }

    private const int PageSize = 6;
    private GamesMode _mode = GamesMode.Decided;
    private IReadOnlyList<BoardGameMondays.Core.BoardGame> _allGames = Array.Empty<BoardGameMondays.Core.BoardGame>();
    private IReadOnlyList<BoardGameMondays.Core.BoardGame> _games = Array.Empty<BoardGameMondays.Core.BoardGame>();
    private readonly Dictionary<GamesMode, int> _pageByMode = new();
    private int _pageIndex;
    private int _pageCount;
    private string _searchText = string.Empty;
    private IReadOnlyList<BoardGameMondays.Core.BoardGame> _searchMatches = Array.Empty<BoardGameMondays.Core.BoardGame>();
    private bool _searchOpen;
    private bool _isAdmin;
    private string? _userId;
    private int _votesRemaining;
    private int _votesLimit;
    private HashSet<Guid> _votedGameIds = new();
    private string? _voteStatus;

    protected override async Task OnInitializedAsync()
    {
        var auth = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = auth.User;
        var viewAsNonAdmin = string.Equals(
            HttpContextAccessor.HttpContext?.Request.Cookies["bgm_viewAsNonAdmin"],
            "1",
            StringComparison.Ordinal);
        _isAdmin = user.Identity?.IsAuthenticated == true && user.IsInRole("Admin") && !viewAsNonAdmin;
        _userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;

        WantToPlayService.Changed += OnWantToPlayChanged;
        await LoadAsync();
    }

    private async Task SetModeAsync(GamesMode mode)
    {
        if (_mode == mode)
        {
            return;
        }

        _mode = mode;
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        if (_allGames.Count == 0)
        {
            _allGames = await BoardGameService.GetAllAsync();
        }

        var status = _mode switch
        {
            GamesMode.Decided => BoardGameMondays.Core.GameStatus.Decided,
            GamesMode.Playing => BoardGameMondays.Core.GameStatus.Playing,
            GamesMode.Queued => BoardGameMondays.Core.GameStatus.Queued,
            _ => BoardGameMondays.Core.GameStatus.Decided
        };

        var gamesForMode = _allGames
            .Where(g => g.Status == status)
            .ToArray();

        _pageIndex = _pageByMode.TryGetValue(_mode, out var page) ? page : 0;
        _pageCount = Math.Max(1, (int)Math.Ceiling(gamesForMode.Length / (double)PageSize));
        _pageIndex = Math.Clamp(_pageIndex, 0, _pageCount - 1);
        _pageByMode[_mode] = _pageIndex;

        _games = gamesForMode
            .Skip(_pageIndex * PageSize)
            .Take(PageSize)
            .ToArray();

        UpdateSearchMatches();
        await RefreshWantToPlayAsync();
    }

    private async Task ChangePageAsync(int page)
    {
        _pageIndex = Math.Clamp(page, 0, _pageCount - 1);
        _pageByMode[_mode] = _pageIndex;
        await LoadAsync();
    }

    private void OnSearchInput(ChangeEventArgs args)
    {
        _searchText = args.Value?.ToString() ?? string.Empty;
        _searchOpen = true;
        UpdateSearchMatches();
    }

    private void OnSearchBlur(FocusEventArgs _)
    {
        _searchOpen = false;
    }

    private void UpdateSearchMatches()
    {
        if (string.IsNullOrWhiteSpace(_searchText))
        {
            _searchMatches = Array.Empty<BoardGameMondays.Core.BoardGame>();
            return;
        }

        _searchMatches = _allGames
            .Where(g => g.Name.Contains(_searchText, StringComparison.OrdinalIgnoreCase))
            .Take(8)
            .ToArray();
    }

    private async Task RefreshWantToPlayAsync()
    {
        if (!_isAdmin || string.IsNullOrWhiteSpace(_userId))
        {
            return;
        }

        var status = await WantToPlayService.GetUserStatusAsync(_userId, DateOnly.FromDateTime(DateTime.Today));
        _votesRemaining = status.VotesRemaining;
        _votesLimit = status.WeeklyLimit;
        _votedGameIds = status.VotedGameIds.ToHashSet();
        _voteStatus = null;
    }

    private bool HasVoted(Guid gameId)
        => _votedGameIds.Contains(gameId);

    private async Task VoteWantToPlayAsync(Guid gameId)
    {
        if (!_isAdmin || string.IsNullOrWhiteSpace(_userId))
        {
            return;
        }

        var result = await WantToPlayService.VoteAsync(_userId, gameId, DateOnly.FromDateTime(DateTime.Today));
        _voteStatus = result.Message;
        await RefreshWantToPlayAsync();
    }

    private void OnWantToPlayChanged()
    {
        _ = InvokeAsync(async () =>
        {
            await RefreshWantToPlayAsync();
            StateHasChanged();
        });
    }

    private async Task SelectSearchMatchAsync(BoardGameMondays.Core.BoardGame game)
    {
        _searchText = game.Name;
        _searchOpen = false;

        var mode = game.Status switch
        {
            BoardGameMondays.Core.GameStatus.Decided => GamesMode.Decided,
            BoardGameMondays.Core.GameStatus.Playing => GamesMode.Playing,
            BoardGameMondays.Core.GameStatus.Queued => GamesMode.Queued,
            _ => GamesMode.Decided
        };

        var gamesForMode = _allGames
            .Where(g => g.Status == game.Status)
            .ToArray();

        var index = Array.FindIndex(gamesForMode, g => g.Id == game.Id);
        var page = index < 0 ? 0 : index / PageSize;
        _pageByMode[mode] = page;

        _mode = mode;
        await LoadAsync();
    }

    private async Task SelectGameAsync(BoardGameMondays.Core.BoardGame game)
    {
        if (OnGameSelected.HasDelegate)
        {
            await OnGameSelected.InvokeAsync(game);
        }
    }

    private enum GamesMode
    {
        Decided = 0,
        Playing = 1,
        Queued = 2
    }

    private static string FormatStatus(BoardGameMondays.Core.GameStatus status)
        => status switch
        {
            BoardGameMondays.Core.GameStatus.Decided => "Decided",
            BoardGameMondays.Core.GameStatus.Playing => "Playing",
            BoardGameMondays.Core.GameStatus.Queued => "Queued",
            _ => "Unknown"
        };

    private IEnumerable<int> GetPageNumbers()
    {
        if (_pageCount <= 1)
        {
            yield break;
        }

        var start = Math.Max(0, _pageIndex - 2);
        var end = Math.Min(_pageCount - 1, start + 4);
        start = Math.Max(0, end - 4);

        for (var i = start; i <= end; i++)
        {
            yield return i;
        }
    }

    public void Dispose()
    {
        WantToPlayService.Changed -= OnWantToPlayChanged;
    }

    private static string FormatReviewedOn(DateTimeOffset date)
    {
        var day = date.Day;
        var suffix = (day % 100) switch
        {
            11 or 12 or 13 => "th",
            _ => (day % 10) switch
            {
                1 => "st",
                2 => "nd",
                3 => "rd",
                _ => "th"
            }
        };

        return $"{day}{suffix} {date:MMMM} {date:yyyy}";
    }
}
